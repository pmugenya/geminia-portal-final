<div class="flex flex-col flex-auto w-full p-4 sm:p-6 md:p-10">
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-[60vh] w-full">
        <mat-spinner diameter="60" color="primary"></mat-spinner>
        <p class="mt-4 text-gray-600 font-medium">Loading quote details...</p>
    </div>
    <div class="bg-card rounded-xl shadow w-full" *ngIf="!isLoading && quote">
        <!-- Header -->
        <div class="p-4 sm:p-6 border-b flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h2 class="text-lg sm:text-xl font-semibold">Marine Quote Details</h2>

            <button
                type="button"
                (click)="goToDashboard()"
                class="inline-flex items-center justify-center gap-2 px-4 py-1 rounded-full border text-sm font-medium bg-white header-close-btn">
                <span class="text-base font-normal" aria-hidden="true">&times;</span>
                <span>Close</span>
            </button>
        </div>

        <!-- Stepper -->
        <div class="p-4 sm:p-6">
            <form [formGroup]="shipmentForm" class="space-y-6 w-full max-w-7xl mx-auto">

                <!-- Step Title -->
                <div class="mb-4 sm:mb-6">
                    <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 text-center sm:text-left">
                        {{ !applicationSubmitted ? 'Provide Marine Details to Pay' : 'Complete Your Payment' }}
                    </h2>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base" *ngIf="!applicationSubmitted">
                        Fill in the required information and submit your application
                    </p>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6" *ngIf="!isLoadingMarineData">

                    <!-- Left Column - Form Fields (Hidden after submission) -->
                    <div class="lg:col-span-7" [class.readonly-section]="applicationSubmitted">

                        <!-- Document Uploads Section -->
                        <div class="mb-4 p-3 sm:p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;">
                            <h2 class="text-sm font-semibold text-gray-900 mb-3">Document Uploads</h2>

                            <!-- IDF Document & Invoice -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <!-- IDF Document -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        IDF Document <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                         [ngClass]="duplicateFileErrors['idfDocument'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('idfDocument')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400 hover:bg-blue-50')"
                                         (click)="idfDocument.click()">
                                        <button type="button" mat-button color="primary" class="text-sm">Choose file</button>
                                        <input hidden #idfDocument type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'idfDocument')">
                                        <p class="text-xs text-gray-500 mt-1 truncate">{{ shipmentForm.get('idfDocument').value?.name || 'No file chosen' }}</p>
                                        <button
                                            *ngIf="shipmentForm.get('idfDocument')?.value"
                                            type="button"
                                            class="mt-1 text-xs font-medium text-primary hover:underline"
                                            (click)="openDocumentPreview('idfDocument', $event)">
                                            View
                                        </button>
                                        <p class="text-xs text-gray-400 mt-1">PDF, JPG, PNG (Max 500KB)</p>
                                    </div>
                                    <p *ngIf="duplicateFileErrors['idfDocument']" class="mt-1 text-xs text-red-600 text-left">
                                        {{ duplicateFileErrors['idfDocument'] }}
                                    </p>
                                </div>

                                <!-- Invoice -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Invoice <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                         [ngClass]="duplicateFileErrors['invoice'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('invoice')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400 hover:bg-blue-50')"
                                         (click)="invoice.click()">
                                        <button type="button" mat-button color="primary" class="text-sm">Choose file</button>
                                        <input hidden #invoice type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'invoice')">
                                        <p class="text-xs text-gray-500 mt-1 truncate">{{ shipmentForm.get('invoice').value?.name || 'No file chosen' }}</p>
                                        <button
                                            *ngIf="shipmentForm.get('invoice')?.value"
                                            type="button"
                                            class="mt-1 text-xs font-medium text-primary hover:underline"
                                            (click)="openDocumentPreview('invoice', $event)">
                                            View
                                        </button>
                                        <p class="text-xs text-gray-400 mt-1">PDF, JPG, PNG (Max 500KB)</p>
                                    </div>
                                    <p *ngIf="duplicateFileErrors['invoice']" class="mt-1 text-xs text-red-600 text-left">
                                        {{ duplicateFileErrors['invoice'] }}
                                    </p>
                                </div>
                            </div>

                            <!-- Conditional Documents (KRA & National ID) -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3" *ngIf="userDocs">
                                <!-- KRA PIN Certificate -->
                                <div *ngIf="!quote.kraDocumentExists">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        KRA PIN Certificate <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                         [ngClass]="duplicateFileErrors['kraPinCertificate'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('kraPinCertificate')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400')"
                                         (click)="kraPinCertificate.click()">
                                        <button type="button" mat-button color="primary" class="text-sm">Choose file</button>
                                        <input hidden #kraPinCertificate type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'kraPinCertificate')">
                                        <p class="text-xs text-gray-500 mt-1 truncate">{{ shipmentForm.get('kraPinCertificate').value?.name || 'No file chosen' }}</p>
                                        <button
                                            *ngIf="shipmentForm.get('kraPinCertificate')?.value"
                                            type="button"
                                            class="mt-1 text-xs font-medium text-primary hover:underline"
                                            (click)="openDocumentPreview('kraPinCertificate', $event)">
                                            View
                                        </button>
                                    </div>
                                    <p *ngIf="duplicateFileErrors['kraPinCertificate']" class="mt-1 text-xs text-red-600 text-left">
                                        {{ duplicateFileErrors['kraPinCertificate'] }}
                                    </p>
                                </div>

                                <!-- National ID -->
                                <div *ngIf="!quote.idDocumentExists">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        National ID <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                         [ngClass]="duplicateFileErrors['nationalId'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('nationalId')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400')"
                                         (click)="nationalId.click()">
                                        <button type="button" mat-button color="primary" class="text-sm">Choose file</button>
                                        <input hidden #nationalId type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'nationalId')">
                                        <p class="text-xs text-gray-500 mt-1 truncate">{{ shipmentForm.get('nationalId').value?.name || 'No file chosen' }}</p>
                                        <button
                                            *ngIf="shipmentForm.get('nationalId')?.value"
                                            type="button"
                                            class="mt-1 text-xs font-medium text-primary hover:underline"
                                            (click)="openDocumentPreview('nationalId', $event)">
                                            View
                                        </button>
                                    </div>
                                    <p *ngIf="duplicateFileErrors['nationalId']" class="mt-1 text-xs text-red-600 text-left">
                                        {{ duplicateFileErrors['nationalId'] }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="mb-4 p-3 sm:p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;">
                            <h2 class="text-sm font-semibold text-gray-900 mb-3">Personal Information</h2>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ID Number *</label>
                                    <input class="w-full px-3 py-2 border rounded-md special-focus-field"
                                           [ngClass]="!shipmentForm.get('idNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="idNumber"
                                           placeholder="Enter ID number"
                                           maxlength="10">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">KRA PIN *</label>
                                    <input class="w-full px-3 py-2 border rounded-md uppercase special-focus-field"
                                           [ngClass]="!shipmentForm.get('kraPin')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="kraPin"
                                           placeholder="Enter KRA PIN"
                                           maxlength="11">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                           formControlName="firstName" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                           formControlName="lastName" readonly>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                                    <input class="w-full px-3 py-2 border rounded-md"
                                           [ngClass]="!shipmentForm.get('emailAddress')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="emailAddress"
                                           type="email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                    <input class="w-full px-3 py-2 border rounded-md bg-gray-100"
                                           [ngClass]="!shipmentForm.get('phoneNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="phoneNumber"
                                           maxlength="10">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Postal Address *</label>
                                    <input class="w-full px-3 py-2 border rounded-md"
                                           [ngClass]="!shipmentForm.get('streetAddress')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="streetAddress"
                                           type="text">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Postal Code *</label>
                                    <select
                                        class="w-full px-3 py-2 border rounded-md special-focus-field"
                                        [ngClass]="!shipmentForm.get('postalCode')?.value ? 'border-red-500' : 'border-gray-300'"
                                        formControlName="postalCode">
                                        <option value="">Select postal code</option>
                                        <option *ngFor="let pc of postalCodes"
                                                [value]="pc.id">
                                            {{ pc.postalCode }} - {{ pc.postalTown }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Shipment Details -->
                        <div class="mb-4 p-3 sm:p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;">
                            <h2 class="text-sm font-semibold text-gray-900 mb-3">Shipment Details</h2>

                            <div class="flex flex-col sm:flex-row sm:flex-wrap items-stretch sm:items-end gap-3 sm:gap-4 mb-3">
                                <div class="flex-1 min-w-0 sm:min-w-[200px]">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mode of Shipment *</label>
                                    <select
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        formControlName="modeOfShipment">
                                        <option value="">Select mode</option>
                                        <option value="1">Sea</option>
                                        <option value="2">Air</option>
                                    </select>
                                </div>

                                <div class="flex-1 min-w-0 sm:min-w-[200px]">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Trade Type</label>
                                    <input
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                        formControlName="tradeType"
                                        value="Marine Cargo Import"
                                        readonly>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">Marine Packaging Type</label>
                                <mat-radio-group formControlName="commodityType" color="primary" class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                                    <mat-radio-button value="1">Containerized</mat-radio-button>
                                    <mat-radio-button value="2">Non-Containerized</mat-radio-button>
                                </mat-radio-group>
                            </div>

                            <!-- Sum Insured (Full Width) -->
                            <div class="mb-3">
                                <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Sum Insured (KES) *</label>
                                <input [class]="'w-full px-3 py-2 border rounded-md bg-gray-100 ' +
                       (!shipmentForm.get('sumInsured')?.value ?
                       'border-red-500' : 'border-gray-300')"
                                       type="text"
                                       formControlName="sumInsured"
                                       appThousands
                                       placeholder="Enter sum insured amount"
                                       inputmode="numeric">
                            </div>

                            <!-- Select Category | Cargo Type -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Select Category *</label>
                                    <mat-form-field appearance="outline" class="w-full category-select mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('selectCategory')?.invalid && shipmentForm.get('selectCategory')?.touched) || !shipmentForm.get('selectCategory')?.value}">
                                        <mat-select formControlName="selectCategory" (selectionChange)="onCategorySelected2($event.value)" #categorySelect2>
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="categoryFilterCtrl2" placeholderLabel="Search categories..."></ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option *ngFor="let category of filteredMarineCategories" [value]="category.catname">
                                                {{ category.catname }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div>
                                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Cargo Type *</label>
                                    <mat-form-field appearance="outline" class="w-full cargo-type-select mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('salesCategory')?.invalid && shipmentForm.get('salesCategory')?.touched) || !shipmentForm.get('salesCategory')?.value}">
                                        <mat-select formControlName="salesCategory" #cargoTypeSelect (selectionChange)="onCategoryTypeSelected2($event.value)"
                                                    [disabled]="isLoadingCargoTypes">
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="cargoTypeFilterCtrl2" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option *ngFor="let type of filteredMarineCargoTypess" [value]="type.ctname">
                                                {{ type.ctname }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>

                            <!-- Vessel Name | IDF Number -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Vessel Name</label>
                                    <input [class]="'w-full px-3 py-2 border rounded-md special-focus-field ' +
                           ((shipmentForm.get('vesselName')?.invalid && shipmentForm.get('vesselName')?.touched) ?
                           'border-red-500' : 'border-gray-300') +
                           (shipmentForm.get('vesselName')?.value ? ' font-bold' : '')"
                                           formControlName="vesselName"
                                           placeholder="Enter the vessel name"
                                           (input)="onVesselNameInput($event)">
                                </div>
                                <div>
                                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">
                                        IDF Number *
                                    </label>
                                    <input [class]="'w-full px-3 py-2 border rounded-md special-focus-field ' +
                           ((shipmentForm.get('gcrNumber')?.invalid && shipmentForm.get('gcrNumber')?.touched) || !shipmentForm.get('gcrNumber')?.value ?
                           'border-red-500' : 'border-gray-300') +
                           (shipmentForm.get('gcrNumber')?.value ? ' font-bold' : '')"
                                           formControlName="gcrNumber"
                                           placeholder="Enter IDF number"
                                           maxlength="16"
                                           style="text-transform: uppercase;"
                                           (input)="onIdfNumberInput($event)">
                                </div>
                            </div>

                            <!-- Date of Dispatch | Estimated Time of Arrival -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Date of Dispatch *</label>
                                    <mat-form-field appearance="outline" class="w-full mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('dateOfDispatch')?.invalid && shipmentForm.get('dateOfDispatch')?.touched) || !shipmentForm.get('dateOfDispatch')?.value}">
                                        <input matInput [matDatepicker]="dispatchPicker" formControlName="dateOfDispatch" [min]="today" readonly>
                                        <mat-datepicker-toggle matSuffix [for]="dispatchPicker"></mat-datepicker-toggle>
                                        <mat-datepicker #dispatchPicker></mat-datepicker>
                                    </mat-form-field>
                                </div>
                                <div>
                                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Date of Arrival *</label>
                                    <mat-form-field appearance="outline" class="w-full mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('estimatedArrival')?.invalid && shipmentForm.get('estimatedArrival')?.touched) || !shipmentForm.get('estimatedArrival')?.value}">
                                        <input matInput [matDatepicker]="arrivalPicker" formControlName="estimatedArrival" [min]="shipmentForm.get('dateOfDispatch')?.value || today" readonly>
                                        <mat-datepicker-toggle matSuffix [for]="arrivalPicker"></mat-datepicker-toggle>
                                        <mat-datepicker #arrivalPicker></mat-datepicker>
                                        <mat-error *ngIf="shipmentForm.get('estimatedArrival')?.hasError('beforeDispatch')">
                                            Date of Arrival cannot be before Date of Dispatch
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>

                            <!-- Country of Origin | Loading Port -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Country of Origin *</label>
                                    <mat-form-field appearance="outline" class="w-full shipping-select mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('countryOfOrigin')?.invalid && shipmentForm.get('countryOfOrigin')?.touched) || !shipmentForm.get('countryOfOrigin')?.value}">

                                        <mat-select formControlName="countryOfOrigin" #countrySelect [compareWith]="compareCountries"
                                                    (openedChange)="onSelectOpen2($event)" (scroll)="onScrollLast($event)">

                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="countryFilterCtrl2" placeholderLabel="Search countries..."></ngx-mat-select-search>
                                            </mat-option>

                                            <mat-option *ngFor="let country of origincountries" [value]="country">
                                                {{ country.countryname }}
                                            </mat-option>

                                            <mat-option *ngIf="loading">
                                                <mat-spinner diameter="20"></mat-spinner> Loading...
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Loading Port *</label>
                                    <mat-form-field appearance="outline" class="w-full shipping-select mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('loadingPort')?.invalid && shipmentForm.get('loadingPort')?.touched) || !shipmentForm.get('loadingPort')?.value}">
                                        <mat-select formControlName="loadingPort"
                                                    #portSelect
                                                    (openedChange)="onSelectOpenPorts($event)"
                                                    (scroll)="onScrollPorts($event)">
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="loadingPortSearchCtrl" placeholderLabel="Search loading ports..."></ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option *ngFor="let port of loadingPorts" [value]="port.id">
                                                {{ port.portName }}
                                            </mat-option>
                                            <mat-option *ngIf="isLoadingLoadingPorts">
                                                <mat-spinner diameter="20"></mat-spinner> Loading ports...
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>

                            <!-- Port of Discharge | Final Destination -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Port of Discharge *</label>
                                    <mat-form-field appearance="outline" class="w-full shipping-select mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('portOfDischarge')?.invalid && shipmentForm.get('portOfDischarge')?.touched) || !shipmentForm.get('portOfDischarge')?.value}">
                                        <mat-select formControlName="portOfDischarge" (openedChange)="onDropdownOpen('dischargePorts')"
                                                    (scroll)="onDischargePortScroll()">
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="dischargePortSearchCtrl" placeholderLabel="Search discharge ports..."></ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option *ngFor="let port of filteredDischargePorts | async" [value]="getPortId(port)">
                                                {{ getPortDisplayName(port) }}
                                            </mat-option>
                                            <mat-option *ngIf="isLoadingDischargePorts" disabled>
                                                <mat-spinner diameter="20"></mat-spinner> Loading ports...
                                            </mat-option>
                                            <mat-option *ngIf="(filteredDischargePorts | async)?.length === 0 && !isLoadingDischargePorts" disabled>
                                                <em>⚠️ Ports unavailable. Please contact support or try again later.</em>
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Final Destination *</label>
                                    <mat-form-field appearance="outline" class="w-full shipping-select mat-small"
                                                    [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('finalDestination')?.invalid && shipmentForm.get('finalDestination')?.touched) || !shipmentForm.get('finalDestination')?.value}">
                                        <mat-select formControlName="finalDestination">
                                            <mat-option>
                                                <ngx-mat-select-search [formControl]="countySearchCtrl" placeholderLabel="Search counties..."></ngx-mat-select-search>
                                            </mat-option>
                                            <mat-option *ngFor="let county of filteredCounties | async" [value]="county.id">
                                                {{ county.portName }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">Description of Goods *</label>
                                <textarea [class]="'w-full px-3 py-2 border rounded-md goods-description-field ' +
                          (!shipmentForm.get('goodsDescription')?.value ?
                          'border-red-500' : 'border-gray-300')"
                                          formControlName="goodsDescription"
                                          placeholder="Enter description of goods"
                                          rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Payment Summary (Always Visible) -->
                    <div class="lg:col-span-5">
                        <div class="bg-white rounded-lg shadow-lg border-2 p-4 sm:p-6 sticky top-4 overflow-visible"
                             [ngClass]="applicationSubmitted ? 'bg-green-50/30' : 'bg-orange-50/30'"
                             style="border-color: #04b2e1;">

                            <!-- Success Message (After Submission) -->
                            <div *ngIf="applicationSubmitted" class="mb-4 sm:mb-6 p-3 sm:p-4 bg-green-100 border border-green-400 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <mat-icon class="text-green-600 mr-2">check_circle</mat-icon>
                                    <h3 class="text-base sm:text-lg font-bold text-green-800">Application Submitted!</h3>
                                </div>
                                <p class="text-xs sm:text-sm text-green-700">Reference: <strong>{{ paymentRefNo }}</strong></p>
                            </div>

                            <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 text-center">
                                {{ applicationSubmitted ? 'Payment Details' : 'Payment Summary' }}
                            </h2>

                            <!-- Cargo Protection -->
                            <div class="mb-4 p-2 sm:p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs sm:text-sm font-medium">Cargo Protection</span>
                                    <mat-icon class="text-blue-600 !w-4 !h-4 !text-sm">info</mat-icon>
                                </div>
                                <div class="mt-1">
                                    <span class="text-sm sm:text-base font-semibold">{{ getCargoProtectionName() }}</span>
                                </div>
                            </div>

                            <!-- Payment Breakdown -->
                            <div class="mb-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200" *ngIf="quoteResult">
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">Sum Insured:</span>
                                        <span class="font-semibold">KES {{ formatAmount(shipmentForm.get('sumInsured')?.value || 0) }}</span>
                                    </div>
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">Basic Premium:</span>
                                        <span class="font-semibold">KES {{ formatAmount(quoteResult.premium) }}</span>
                                    </div>
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">PHCF (0.25%):</span>
                                        <span class="font-semibold">KES {{ formatAmount(quoteResult.phcf) }}</span>
                                    </div>
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">Training Levy (0.2%):</span>
                                        <span class="font-semibold">KES {{ formatAmount(quoteResult.tl) }}</span>
                                    </div>
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">Stamp Duty:</span>
                                        <span class="font-semibold">KES {{ formatAmount(quoteResult.sd) }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Amount -->
                            <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-lg" *ngIf="quoteResult" style="background-color: #21275c;">
                                <div class="flex justify-between items-center text-white">
                                    <span class="text-sm sm:text-lg font-bold">Total Payable:</span>
                                    <span class="text-lg sm:text-2xl font-bold">KES {{ quoteResult.netprem | number:'1.2-2' }}</span>
                                </div>
                            </div>

                            <!-- Payment Instructions (After Submission) -->
                            <div *ngIf="applicationSubmitted" class="space-y-4">
                                <div class="p-3 sm:p-4 bg-white rounded-lg border-2 border-blue-300">
                                    <h3 class="font-bold text-gray-900 mb-3 sm:mb-4 flex items-center text-sm sm:text-base">
                                        <mat-icon class="text-blue-600 mr-2 !w-5 !h-5">payment</mat-icon>
                                        M-PESA Payment
                                    </h3>

                                    <!-- Payment Method Tabs -->
                                    <div class="flex mb-4 bg-gray-100 rounded-lg p-1">
                                        <button
                                            type="button"
                                            class="flex-1 py-2 px-2 sm:px-4 rounded-md text-xs sm:text-sm font-medium transition-all duration-200 flex items-center justify-center gap-1"
                                            [ngClass]="paymentMethod === 'stk' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:text-gray-900'"
                                            (click)="paymentMethod = 'stk'">
                                            <mat-icon class="!w-4 !h-4 !text-base">phone_android</mat-icon>
                                            <span>STK Push</span>
                                        </button>
                                        <button
                                            type="button"
                                            class="flex-1 py-2 px-2 sm:px-4 rounded-md text-xs sm:text-sm font-medium transition-all duration-200 flex items-center justify-center gap-1"
                                            [ngClass]="paymentMethod === 'paybill' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:text-gray-900'"
                                            (click)="paymentMethod = 'paybill'">
                                            <mat-icon class="!w-4 !h-4 !text-base">receipt_long</mat-icon>
                                            <span>Paybill</span>
                                        </button>
                                    </div>

                                    <!-- STK Push Option -->
                                    <div *ngIf="paymentMethod === 'stk'" class="space-y-3">
                                        <div class="p-2 sm:p-3 bg-blue-50 rounded-lg border border-blue-100">
                                            <p class="text-xs sm:text-sm text-blue-800 flex items-start gap-2">
                                                <mat-icon class="!w-4 !h-4 !text-base flex-shrink-0 mt-0.5">info</mat-icon>
                                                <span>We'll send a payment prompt to your phone. Enter your M-PESA PIN to complete.</span>
                                            </p>
                                        </div>

                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="p-2 bg-gray-50 rounded text-center">
                                                <span class="text-xs text-gray-500 block">Paybill</span>
                                                <span class="font-bold text-gray-900 text-sm">553201</span>
                                            </div>
                                            <div class="p-2 bg-gray-50 rounded text-center">
                                                <span class="text-xs text-gray-500 block">Account</span>
                                                <span class="font-bold text-gray-900 text-sm break-all">{{ paymentRefNo }}</span>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Enter M-PESA Number *
                                            </label>
                                            <input
                                                class="w-full px-3 py-3 sm:py-2 border rounded-md text-base sm:text-sm"
                                                [ngClass]="!shipmentForm.get('mpesaNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                                formControlName="mpesaNumber"
                                                placeholder="07XX XXX XXX"
                                                maxlength="10"
                                                inputmode="numeric"
                                                type="tel"
                                                (input)="onMpesaNumberInput($event)">
                                            <p class="text-xs text-gray-500 mt-1">Enter the M-PESA number to receive the prompt</p>
                                        </div>

                                        <!-- STK Push Button -->
                                        <button
                                            type="button"
                                            class="w-full py-3 text-sm sm:text-base font-semibold rounded-full flex items-center justify-center transition-all duration-200"
                                            [disabled]="isProcessPayment || !shipmentForm.get('mpesaNumber')?.value"
                                            [ngClass]="{
                                                'bg-gray-300 text-gray-500 cursor-not-allowed': isProcessPayment || !shipmentForm.get('mpesaNumber')?.value,
                                                'bg-[#21275c] text-white hover:bg-[#2d3470] cursor-pointer': !isProcessPayment && shipmentForm.get('mpesaNumber')?.value
                                            }"
                                            (click)="initiatePayment()">
                                            <mat-spinner *ngIf="isProcessPayment" diameter="20" class="mr-2"></mat-spinner>
                                            <mat-icon *ngIf="!isProcessPayment" class="mr-2">send</mat-icon>
                                            <span>{{ isProcessPayment ? 'Processing...' : 'Send Payment Prompt' }}</span>
                                        </button>

                                        <p class="text-xs text-center text-gray-500 mt-2">
                                            You will receive an M-PESA prompt on your phone.
                                        </p>
                                    </div>

                                    <!-- Paybill Validation Option -->
                                    <div *ngIf="paymentMethod === 'paybill'" class="space-y-3">
                                        <div class="p-2 sm:p-3 bg-blue-50 rounded-lg border border-blue-100">
                                            <p class="text-xs sm:text-sm text-blue-800 flex items-start gap-2">
                                                <mat-icon class="!w-4 !h-4 !text-base flex-shrink-0 mt-0.5">check_circle</mat-icon>
                                                <span>Already paid via M-PESA? Enter your transaction code to validate.</span>
                                            </p>
                                        </div>

                                        <!-- Paybill Instructions - Collapsible -->
                                        <details class="bg-gray-50 rounded-lg border border-gray-200">
                                            <summary class="p-2 sm:p-3 cursor-pointer font-semibold text-gray-900 flex items-center text-xs sm:text-sm">
                                                <mat-icon class="text-green-600 mr-2 !w-4 !h-4">smartphone</mat-icon>
                                                How to Pay via Paybill
                                                <mat-icon class="ml-auto !w-4 !h-4 text-gray-500">expand_more</mat-icon>
                                            </summary>
                                            <ol class="text-xs text-gray-700 space-y-1.5 px-3 pb-3">
                                                <li class="flex items-start">
                                                    <span class="flex-shrink-0 w-4 h-4 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center mr-2 mt-0.5">1</span>
                                                    <span>Go to M-PESA menu</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="flex-shrink-0 w-4 h-4 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center mr-2 mt-0.5">2</span>
                                                    <span><strong>Lipa na M-PESA</strong> → <strong>Pay Bill</strong></span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="flex-shrink-0 w-4 h-4 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center mr-2 mt-0.5">3</span>
                                                    <span>Business No: <strong class="text-blue-700">553201</strong></span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="flex-shrink-0 w-4 h-4 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center mr-2 mt-0.5">4</span>
                                                    <span>Account: <strong class="text-blue-700">{{ paymentRefNo }}</strong></span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="flex-shrink-0 w-4 h-4 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center mr-2 mt-0.5">5</span>
                                                    <span>Amount: <strong class="text-blue-700">{{ quoteResult?.netprem | number:'1.0-0' }}</strong></span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="flex-shrink-0 w-4 h-4 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center mr-2 mt-0.5">6</span>
                                                    <span>Enter PIN and confirm</span>
                                                </li>
                                            </ol>
                                        </details>

                                        <!-- Payment Details Summary -->
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="p-2 bg-gray-50 rounded-lg text-center">
                                                <span class="text-xs text-gray-500 block">Paybill</span>
                                                <span class="font-bold text-gray-900 text-sm">553201</span>
                                            </div>
                                            <div class="p-2 bg-gray-50 rounded-lg text-center">
                                                <span class="text-xs text-gray-500 block">Account</span>
                                                <span class="font-bold text-gray-900 text-sm break-all">{{ paymentRefNo }}</span>
                                            </div>
                                            <div class="p-2 bg-blue-50 rounded-lg col-span-2 text-center">
                                                <span class="text-xs text-blue-600 block">Amount to Pay</span>
                                                <span class="font-bold text-blue-700 text-base sm:text-lg">KES {{ quoteResult?.netprem | number:'1.2-2' }}</span>
                                            </div>
                                        </div>

                                        <!-- M-PESA Transaction Code Input -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Enter M-PESA Transaction Code *
                                            </label>
                                            <input
                                                class="w-full px-3 py-3 sm:py-2.5 border rounded-lg focus:ring-2 text-center text-lg font-mono tracking-widest uppercase"
                                                [ngClass]="{
                                                    'border-red-500 focus:ring-red-500 bg-red-50': mpesaCodeError,
                                                    'border-green-500 focus:ring-green-500 bg-green-50': mpesaCodeValid,
                                                    'border-gray-300 focus:ring-blue-500': !mpesaCodeError && !mpesaCodeValid
                                                }"
                                                formControlName="mpesaCode"
                                                placeholder="SJK7H9TXYZ"
                                                maxlength="10"
                                                autocapitalize="characters"
                                                autocomplete="off"
                                                spellcheck="false"
                                                (input)="onMpesaCodeInput($event)">
                                            <p class="text-xs text-gray-500 mt-1 text-center">
                                                Find this code in your M-PESA SMS
                                            </p>
                                            <p *ngIf="mpesaCodeError" class="text-xs text-red-600 mt-2 p-2 bg-red-50 rounded-lg">
                                                <mat-icon class="!w-4 !h-4 !text-sm align-middle mr-1">error</mat-icon>
                                                {{ mpesaCodeError }}
                                            </p>
                                        </div>

                                        <!-- Validate Payment Button -->
                                        <button
                                            type="button"
                                            class="w-full py-3 text-sm sm:text-base font-semibold rounded-full flex items-center justify-center transition-all duration-200"
                                            (click)="validateMpesaPayment()">
                                            <mat-spinner *ngIf="validatingPayment" diameter="20" class="mr-2"></mat-spinner>
                                            <mat-icon *ngIf="!validatingPayment" class="mr-2">verified</mat-icon>
                                            <span>{{ validatingPayment ? 'Validating...' : 'Validate Payment' }}</span>
                                        </button>

                                        <p class="text-xs text-center text-gray-500 mt-2">
                                            We'll verify your payment against our records.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Application Buttons (Before Submission) -->
                            <div *ngIf="!applicationSubmitted" class="mt-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                    <!-- Save & Pay Now -->
                                    <button
                                        mat-raised-button
                                        color="primary"
                                        class="w-full py-3 text-sm sm:text-base font-semibold rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition"
                                        [disabled]="isSubmitting"
                                        (click)="onSubmit()"
                                        style="background-color: #21275c; color: #ffffff;">
                                        <ng-container *ngIf="!isSubmitting; else submittingNow">
                                            Save & Pay Now
                                        </ng-container>
                                        <ng-template #submittingNow>
                                            <mat-spinner diameter="20" class="payment-spinner"></mat-spinner>
                                        </ng-template>
                                    </button>

                                    <!-- Save & Pay Later -->
                                    <button
                                        mat-raised-button
                                        color="primary"
                                        class="w-full py-3 text-sm sm:text-base font-semibold rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition"
                                        [disabled]="isSubmitting"
                                        (click)="onSubmitPayLater()"
                                        style="background-color: #4b5563; color: #ffffff;">
                                        <ng-container *ngIf="!isSubmitting; else submittingLater">
                                            Save & Pay Later
                                        </ng-container>
                                        <ng-template #submittingLater>
                                            <mat-spinner diameter="20" class="payment-spinner"></mat-spinner>
                                        </ng-template>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div *ngIf="showDocumentPreviewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-2 sm:p-4" (click)="closeDocumentPreview()">
    <div class="max-h-[95vh] w-full max-w-4xl overflow-hidden rounded-lg bg-white shadow-xl" (click)="$event.stopPropagation()">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-3 py-3 sm:px-6 sm:py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800">Document Preview</h2>
                    <p class="text-xs sm:text-sm text-gray-500 truncate mt-1">{{ previewDocumentName }}</p>
                </div>
                <button (click)="closeDocumentPreview()" class="text-gray-400 hover:text-gray-600 p-1">
                    <mat-icon class="text-lg sm:text-xl">close</mat-icon>
                </button>
            </div>
        </div>

        <div class="px-3 py-4 sm:px-6 sm:py-6 max-h-[80vh] overflow-auto bg-gray-50">
            <ng-container *ngIf="previewDocumentUrl as docUrl">
                <!-- Image preview -->
                <img
                    *ngIf="previewDocumentType.startsWith('image/')"
                    [src]="docUrl"
                    class="max-h-[70vh] w-auto mx-auto rounded-md border border-gray-200 bg-white"
                    alt="Uploaded document preview"/>

                <!-- PDF preview (with fallback link) -->
                <div *ngIf="previewDocumentType === 'application/pdf'" class="w-full h-[70vh]">
                    <iframe
                        [src]="previewSafeUrl"
                        class="w-full h-full rounded-md border border-gray-200 bg-white"
                        title="PDF preview"></iframe>
                    <div class="mt-2 text-xs text-gray-500">
                        If the PDF does not display correctly, you can
                        <a [href]="docUrl" target="_blank" class="text-primary hover:underline">open it in a new tab</a>.
                    </div>
                </div>

                <!-- Fallback for other types -->
                <div *ngIf="!previewDocumentType || (previewDocumentType !== 'application/pdf' && !previewDocumentType.startsWith('image/'))" class="text-sm text-gray-700">
                    <p class="mb-2">This file type cannot be previewed here.</p>
                    <a [href]="docUrl" target="_blank" class="text-primary hover:underline text-sm">Open document in a new tab</a>
                </div>
            </ng-container>
        </div>

        <div class="sticky bottom-0 bg-white border-t border-gray-200 px-3 py-3 sm:px-6 sm:py-4 flex justify-end">
            <button (click)="closeDocumentPreview()" class="rounded-md bg-primary px-3 py-2 sm:px-4 text-sm sm:text-base text-white hover:bg-secondary">Close</button>
        </div>
    </div>
</div>
