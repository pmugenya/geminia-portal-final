<div class="flex flex-col flex-auto w-full p-6 md:p-10">
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-[60vh] w-full">
        <mat-spinner diameter="60" color="primary"></mat-spinner>
        <p class="mt-4 text-gray-600 font-medium">Loading quote details...</p>
    </div>
    <div class="bg-card rounded-xl shadow w-full" *ngIf="!isLoading">
        <!-- Header -->
        <div class="p-6 border-b">
            <h2 class="text-xl font-semibold">My Policies</h2>
        </div>

        <div class="p-6">
            <div class="bg-card rounded-xl shadow">
                <div class="flex items-center justify-between p-6 border-b">
                    <div>
                        <h3 class="text-lg font-semibold">My Policies</h3>
                    </div>
                </div>
                <div class="text-secondary text-sm" *ngIf="!isInitialLoad">
                    Showing {{ myPolicyDataSource.data.length }} of {{ policiesTotalRecords }} policies
                </div>
                <div class="overflow-x-auto">
                    <table
                        class="w-full"
                        mat-table
                        matSort
                        [dataSource]="myPolicyDataSource"
                        [trackBy]="trackByFn"
                        #myPoliciesTable
                    >

                        <ng-container matColumnDef="productName">
                            <th mat-header-cell *matHeaderCellDef>Product</th>
                            <td mat-cell *matCellDef="let policy">
                                <div class="flex items-center">
                                    {{ policy.productName }}
                                </div>
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="clientName">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Client Name</th>
                            <td mat-cell *matCellDef="let policy">
                                <div class="flex items-center">
                                    {{ policy.clientName }}
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="erprefno">
                            <th mat-header-cell *matHeaderCellDef>Policy No</th>
                            <td mat-cell *matCellDef="let policy">{{ policy.erprefno }}</td>
                        </ng-container>

                        <!-- Coverage Amount -->
                        <ng-container matColumnDef="netpremium">
                            <th mat-header-cell *matHeaderCellDef>Premium</th>
                            <td mat-cell *matCellDef="let policy">
                                <span class="font-medium">{{ policy.netpremium | currency:'KES ' }}</span>
                            </td>
                        </ng-container>

                        <!-- Premium -->
                        <ng-container matColumnDef="coverFrom">
                            <th mat-header-cell *matHeaderCellDef>Cover From</th>
                            <td mat-cell *matCellDef="let policy">
                                {{ policy.coverFrom | date }}
                            </td>
                        </ng-container>

                        <!-- Renewal Date -->
                        <ng-container matColumnDef="coverTo">
                            <th mat-header-cell *matHeaderCellDef>Cover To</th>
                            <td mat-cell *matCellDef="let policy">
                                <div [class.text-red-600]="isExpiringSoon(policy.coverTo)"
                                     [class.font-semibold]="isExpiringSoon(policy.coverTo)">
                                    {{ formatDate(policy.coverTo) }}
                                    <div class="text-xs text-secondary" *ngIf="isExpiringSoon(policy.coverTo)">
                                        {{ getDaysUntilRenewal(policy.coverTo) }} days left
                                    </div>
                                </div>
                            </td>
                        </ng-container>

                        <!-- Actions -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let policy">
                                <div class="flex flex-wrap gap-2">
                                    <button
                                        mat-stroked-button
                                        color="primary"
                                        class="px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1"
                                        (click)="viewPolicy(policy)">
                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:eye'"></mat-icon>
                                        <span>View Policy</span>
                                    </button>
                                    <button
                                        mat-stroked-button
                                        color="primary"
                                        class="px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1"
                                        (click)="downloadPolicy(policy)">
                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:arrow-down-tray'"></mat-icon>
                                        <span>Download Policy</span>
                                    </button>
                                    <button
                                        *ngIf="policy.status === 'renewal'"
                                        mat-stroked-button
                                        color="accent"
                                        class="px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1"
                                        (click)="renewPolicy(policy)">
                                        <mat-icon class="icon-size-4 text-green-600" [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                                        <span>Renew</span>
                                    </button>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="myPolicyTableColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: myPolicyTableColumns;"></tr>
                    </table>
                </div>
                <mat-paginator
                    *ngIf="!isInitialLoad && policiesTotalRecords > 0"
                    [length]="policiesTotalRecords"
                    [pageSize]="policiesPageSize"
                    [pageSizeOptions]="pageSizeOptions"
                    [pageIndex]="currentPage"
                    (page)="onPoliciesPageChange($event)"
                    showFirstLastButtons="true"
                >
                </mat-paginator>
            </div>
        </div>
    </div>
</div>
