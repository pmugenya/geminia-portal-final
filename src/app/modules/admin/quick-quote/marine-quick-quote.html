<div class="flex flex-col flex-auto w-full p-4 md:p-8">
    <div class="bg-card rounded-xl shadow w-full">
        <!-- Header -->
        <div class="p-6 border-b flex items-center justify-between">
            <h2 class="text-xl font-semibold">Quick Marine Quote Details</h2>

            <button
                type="button"
                (click)="closeQuote.emit()"
                class="inline-flex items-center gap-2 px-4 py-1 rounded-full border text-sm font-medium bg-white header-close-btn">
                <span class="text-base font-normal" aria-hidden="true">&times;</span>
                <span>Close</span>
            </button>
        </div>

        <!-- Stepper -->
        <div class="p-6">
            <mat-horizontal-stepper [linear]="true" #stepper class="w-full">
                <!-- Step 1 -->
                <mat-step [stepControl]="quotationForm">
                    <ng-template matStepLabel>Shipment Details</ng-template>
                    <form [formGroup]="quotationForm" class="space-y-6 w-full">
                        <fuse-alert
                            *ngIf="submissionError"
                            [title]="'Submission Failed!'"
                            [type]="'error'"
                            [dismissible]="true"
                            (dismiss)="submissionError = null">
                            {{ submissionError }}
                        </fuse-alert>

                        <h3 class="mb-3 sm:mb-4 text-lg sm:text-xl font-semibold text-gray-800">Shipment Details</h3>
                        <p class="mb-3 sm:mb-4 text-xs sm:text-sm text-gray-500 font-medium" *ngIf="false">This is the person or entity purchasing the insurance policy.</p>
                        <div class="mb-6 rounded-lg border border-gray-200 bg-white p-4" *ngIf="false">
                            <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                <div *ngIf="false"><label class="mb-2 block text-base font-medium text-gray-700">First Name <span class="text-red-500">*</span></label><input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 text-base text-gray-900" (input)="onFirstNameInput($event)" [ngClass]="(quotationForm.get('firstName')?.invalid && quotationForm.get('firstName')?.touched) || !quotationForm.get('firstName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                                <div *ngIf="false"><label class="mb-2 block text-base font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label><input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 text-base text-gray-900" (input)="onLastNameInput($event)" [ngClass]="(quotationForm.get('lastName')?.invalid && quotationForm.get('lastName')?.touched) || !quotationForm.get('lastName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                                <div *ngIf="false"><label class="mb-2 block text-base font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label><input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 text-base text-gray-900" (keydown)="preventSpaceInEmail($event)" (input)="onEmailInput($event)" autocapitalize="off" autocomplete="email" autocorrect="off" spellcheck="false" inputmode="email" [ngClass]="(quotationForm.get('email')?.invalid && quotationForm.get('email')?.touched) || !quotationForm.get('email')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                                <div *ngIf="false"><label class="mb-2 block text-base font-medium text-gray-700">Phone Number <span class="text-red-500">*</span></label><input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 text-base text-gray-900" (input)="onPhoneNumberInput($event)" [ngClass]="(quotationForm.get('phoneNumber')?.invalid && quotationForm.get('phoneNumber')?.touched) || !quotationForm.get('phoneNumber')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>

                            </div>
                        </div>

                        <div class="mb-6 rounded-lg border border-gray-200 bg-white p-4">
                            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                <!-- Mode of Shipment -->
                                <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">
                                    Mode of Shipment <span class="text-red-500">*</span>
                                </label>
                                <mat-form-field appearance="outline" class="w-full mat-small">
                                    <mat-select formControlName="modeOfShipment" placeholder="Mode of Shipment *">
                                        <mat-option value="" disabled>Mode of Shipment *</mat-option>
                                        <mat-option value="1">Sea</mat-option>
                                        <mat-option value="2">Air</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                                <!-- Trade Type -->
                                <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">
                                    Trade Type <span class="text-red-500">*</span>
                                </label>
                                <mat-form-field appearance="outline" class="w-full mat-small">
                                    <mat-select formControlName="tradeType" placeholder="Trade Type *">
                                        <mat-option value="" disabled>Trade Type *</mat-option>
                                        <mat-option value="1">Import</mat-option>
                                        <mat-option value="2">Export</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                </div>
                            </div>


                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <!-- Cargo Protection -->
                                <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">Cargo Protection</label>
                                <input
                                    type="text"
                                    formControlName="marineProduct"
                                    class="w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-gray-900 h-12"
                                    readonly
                                />
                            </div>

                                <!-- Marine Packaging Type -->
                                <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">
                                    Marine Packaging Type <span class="text-red-500">*</span>
                                </label>

                                <mat-radio-group
                                    formControlName="marinePackagingType"
                                    class="flex flex-col sm:flex-row gap-1 sm:gap-2 items-start sm:items-center px-3 py-0.5 rounded-md border text-gray-700"
                                    [ngClass]="quotationForm.get('marinePackagingType')?.invalid && quotationForm.get('marinePackagingType')?.touched
          ? 'border-red-500 bg-red-50'
          : 'border-gray-300 bg-white'
      "
                                >
                                    <mat-radio-button
                                        value="1"
                                        class="m-0 flex items-center text-sm"
                                        style="padding: 0 0.25rem;"
                                    >
                                        Containerized
                                    </mat-radio-button>

                                    <mat-radio-button
                                        value="2"
                                        class="m-0 flex items-center text-sm"
                                        style="padding: 0 0.25rem;"
                                    >
                                        Non-Containerized
                                    </mat-radio-button>
                                </mat-radio-group>

                                
                                </div>
                            </div>




                            <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                <!-- Select Category -->
                                <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">Select Category <span class="text-red-500">*</span></label>
                                <mat-form-field
                                    appearance="outline"
                                    class="w-full category-select mat-small"
                                    [ngClass]="quotationForm.get('marineCategory')?.invalid && quotationForm.get('marineCategory')?.touched ? 'mat-select-invalid' : ''"
                                >
                                    <mat-select formControlName="marineCategory" placeholder="Select Category *" (selectionChange)="onCategorySelected($event.value)" #categorySelect>
                                        <mat-option>
                                            <ngx-mat-select-search [formControl]="categoryFilterCtrl" placeholderLabel="Search categories..."></ngx-mat-select-search>
                                        </mat-option>
                                        <mat-option *ngFor="let category of filteredMarineCategories" [value]="category.catname">
                                            {{ category.catname }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                                <!-- Marine Cargo Type -->
                                <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">Marine Cargo Type <span class="text-red-500">*</span></label>
                                <mat-form-field appearance="outline" class="w-full cargo-type-select mat-small">
                                    <mat-select formControlName="marineCargoType" placeholder="Marine Cargo Type *" (selectionChange)="onCategoryTypeSelected($event.value)"
                                                #cargoTypeSelect [disabled]="isLoadingCargoTypes">
                                        <mat-option>
                                            <ngx-mat-select-search [formControl]="cargoTypeFilterCtrl" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                                        </mat-option>
                                        <mat-option *ngFor="let type of filteredMarineCargoTypes" [value]="type.ctname">
                                            {{ type.ctname }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                                </div>
                            </div>


                            <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                <!-- Updated Country of Origin with Searchable Dropdown -->
                                <div>
                                <label class="mb-2 block text-base font-medium text-gray-700">Country of Origin <span class="text-red-500">*</span></label>
                                <mat-form-field appearance="outline" class="w-full country-select">
                                    <mat-select formControlName="origin" #countrySelect2
                                                (openedChange)="onSelectOpen($event)"
                                                (selectionChange)="onOriginChange($event)"
                                                (scroll)="onScroll($event)"
                                                [disabled]="loading">
                                        <div class="search-container flex items-center px-2" (click)="$event.stopPropagation()">
                                            <mat-icon class="text-gray-400">search</mat-icon>
                                            <input
                                                matInput
                                                type="text"
                                                placeholder="Search..."
                                                [formControl]="countryFilterCtrl"
                                                (keydown)="$event.stopPropagation()"
                                            />
                                        </div>

                                        <mat-option *ngFor="let country of countries" [value]="country.id">
                                            {{ country.countryname }}
                                        </mat-option>

                                        <mat-option *ngIf="loading">
                                            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>


                            </div>

                            <div>
                                <label class="mb-2 block text-base font-medium text-gray-700">Destination</label>
                                <input type="text" formControlName="destination" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2 text-gray-900 h-14" readonly/>
                                </div>
                            </div>

                            <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label>
                                    <input
                                        type="email"
                                        formControlName="email"
                                        class="w-full rounded-md border bg-white px-3 py-2 text-base text-gray-900 h-12 email-input"
                                        (keydown)="preventSpaceInEmail($event)"
                                        (input)="onEmailInput($event)"
                                        autocapitalize="off"
                                        autocomplete="email"
                                        autocorrect="off"
                                        spellcheck="false"
                                        inputmode="email"
                                        [ngClass]="(quotationForm.get('email')?.invalid && quotationForm.get('email')?.touched) || !quotationForm.get('email')?.value ? 'border-red-500' : 'border-gray-300'"
                                    />
                                </div>

                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Sum Insured (KES) <span class="text-red-500">*</span></label>
    <!--                            <input type="text" formControlName="sumInsured" appThousands placeholder="2,500,000" inputmode="numeric" class="w-full rounded-md border bg-white px-3 py-2 text-base" [ngClass]="(quotationForm.get('sumInsured')?.invalid && quotationForm.get('sumInsured')?.touched) || !quotationForm.get('sumInsured')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/>-->
                                    <input
                                        type="text"
                                        formControlName="sumInsured"
                                        placeholder="00.00"
                                        appThousands
                                        class="w-full rounded-md border bg-white px-3 py-2 text-base text-gray-900 sum-insured-input h-12"
                                        [ngClass]="(quotationForm.get('sumInsured')?.invalid && quotationForm.get('sumInsured')?.touched) || !quotationForm.get('sumInsured')?.value ? 'border-red-500' : 'border-gray-300'"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Policy Consent -->
                        <div class="mt-1 space-y-2"
                             [ngClass]="quotationForm.get('termsAndPolicyConsent')?.invalid && quotationForm.get('termsAndPolicyConsent')?.touched ? 'border border-red-500 bg-red-50 rounded-md p-3' : ''">
                            <label class="flex items-start">
                                <input
                                    type="checkbox"
                                    formControlName="termsAndPolicyConsent"
                                    class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary"/>
                                <span class="ml-3 text-sm text-gray-700">
                                    I agree to the
                                    <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Terms of Use</a>
                                    and to the
                                    <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*
                                </span>
                            </label>
                            <p
                                *ngIf="quotationForm.get('termsAndPolicyConsent')?.invalid && quotationForm.get('termsAndPolicyConsent')?.touched"
                                class="text-xs text-red-600 mt-1">
                                You must agree to the Terms of Use and Data Privacy Policy to continue.
                            </p>
                        </div>

                        <div class="flex justify-end mt-1">
                            <button
                                mat-flat-button
                                color="primary"
                                (click)="submitQuotation()"
                                class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all">
                                Next
                            </button>
                        </div>
                    </form>
                </mat-step>

                <!-- Step 2 -->
                <!-- Step 2 -->
                <mat-step [stepControl]="coverageFormGroup">
                    <ng-template matStepLabel>Marine Quote Details</ng-template>
                    <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-[60vh] w-full">
                        <mat-spinner diameter="60" color="primary"></mat-spinner>
                        <p class="mt-4 text-gray-600 font-medium">Loading quote details...</p>
                    </div>

                    <form [formGroup]="coverageFormGroup" class="space-y-6 w-full max-w-4xl mx-auto">

                        <!-- Error Alert -->
                        <fuse-alert
                            name="quoteDownloadError"
                            type="error"
                            [dismissible]="true"
                            [appearance]="'soft'">
                            Failed to download quote. Please try again later.
                        </fuse-alert>

                        <!-- Step Title -->
                        <div class="flex items-center justify-between border-b pb-4 mb-6" *ngIf="!isLoading && quote">
                            <div>
                                <h2 class="text-2xl !font-bold leading-8 tracking-tight text-gray-900">
                                    Quote Details
                                </h2>

                                <div class="text-base font-semibold text-gray-700 tracking-tight">
                                    Reference:
                                    <span class="reference-pill">{{ quote?.refno }}</span>
                                </div>
                            </div>

                            <div class="flex items-center space-x-3">
                                <button
                                    mat-flat-button
                                    color="primary"
                                    class="download-btn"
                                    (click)="downloadQuote()">
                                    <mat-icon svgIcon="heroicons_outline:arrow-down-tray" class="mr-2"></mat-icon>
                                    Download Quote
                                </button>
                                <button
                                    type="button"
                                    (click)="closeQuote.emit()"
                                    class="inline-flex items-center gap-2 px-4 py-1 rounded-full border text-sm font-medium bg-white header-close-btn">
                                    <span class="text-base font-normal" aria-hidden="true">&times;</span>
                                    <span>Close</span>
                                </button>
                            </div>
                        </div>

                        <!-- Basic Info Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                            <!-- Customer -->
                            <div class="bg-white rounded-xl shadow p-5 border border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2">Customer</h3>

                                <div class="text-lg font-bold text-gray-900">
                                    {{ quote?.firstName }} {{ quote?.lastName }}
                                </div>
                                <div class="text-sm text-gray-700">{{ quote?.email }}</div>
                                <div class="text-sm text-gray-700">{{ quote?.phoneNo }}</div>
                            </div>

                            <!-- Product -->
                            <div class="bg-white rounded-xl shadow p-5 border border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2">Category & Product</h3>

                                <div class="text-lg font-bold text-gray-900">{{ quote?.category }}</div>
                                <div class="text-sm text-gray-700">{{ quote?.prodName }}</div>
                            </div>

                            <!-- Status -->
                            <div class="bg-white rounded-xl shadow p-5 border border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2">Status</h3>

                                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-bold"
                                      [ngClass]="getStatusColor(quote?.status)">
                {{ quote?.status }}
            </span>

                                <div class="text-sm text-gray-700 mt-2">
                                    Expires on:
                                    <span class="font-semibold text-gray-900">{{ quote?.expiryDate | date }}</span>
                                </div>
                            </div>

                        </div>

                        <!-- Shipping & Cargo Details -->
                        <div class="bg-white rounded-xl shadow p-6 mt-8 border border-gray-200">
                            <h3 class="text-lg !font-bold text-gray-900 mb-4">
                                Shipping & Cargo Details
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Origin Country</label>
                                    <div class="font-bold text-gray-900">{{ quote?.originId }}</div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Destination</label>
                                    <div class="font-bold text-gray-900">{{ quote?.destination }}</div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Vessel Name</label>
                                    <div class="font-bold text-gray-900">{{ quote?.vesselName }}</div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Cargo Type</label>
                                    <div class="font-bold text-gray-900">{{ quote?.cargotype }}</div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Shipping Mode</label>
                                    <div class="font-bold text-gray-900">{{ quote?.shippingmode }}</div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Packaging Type</label>
                                    <div class="font-bold text-gray-900">{{ quote?.packagingtype }}</div>
                                </div>

                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="bg-white rounded-xl shadow p-6 mt-8 border border-gray-200">
                            <h3 class="text-lg !font-bold text-gray-900 mb-4">Premium Details</h3>

                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Sum Assured</label>
                                    <div class="text-lg font-bold text-gray-900">
                                        {{ quote?.sumassured | currency:'KES ' }}
                                    </div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Premium</label>
                                    <div class="text-lg font-bold text-gray-900">
                                        {{ quote?.premium | currency:'KES ' }}
                                    </div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">PHCF</label>
                                    <div class="text-lg font-bold text-gray-900">
                                        {{ quote?.phcf | currency:'KES ' }}
                                    </div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Training Levy</label>
                                    <div class="text-lg font-bold text-gray-900">
                                        {{ quote?.traininglevy | currency:'KES ' }}
                                    </div>
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Stamp Duty</label>
                                    <div class="text-lg font-bold text-gray-900">
                                        {{ quote?.sd | currency:'KES ' }}
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-center text-sm font-semibold text-gray-700">
                                        <span>Net Premium</span>
                                        <span class="net-premium-amount">
                                            {{ quote?.netprem | currency:'KES ' }}
                                        </span>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Description -->
                        <div class="bg-white rounded-xl shadow p-6 mt-8 border border-gray-200" *ngIf="false">
                            <h3 class="text-lg !font-bold text-gray-900 mb-3">Description</h3>

                            <p class="text-gray-700 text-base leading-relaxed font-medium">
                                {{ quote?.description || 'No description provided for this quote.' }}
                            </p>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex flex-col sm:flex-row justify-between mt-6 gap-3">

                            <button
                                mat-stroked-button
                                (click)="stepper.previous()"
                                class="w-full sm:w-auto px-6 py-2 rounded-lg shadow-sm text-gray-900 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all">
                                Cancel
                            </button>

                            <button
                                mat-flat-button
                                color="primary"
                                (click)="buyNow()"
                                class="w-full sm:w-auto px-6 py-2 rounded-lg shadow-md text-white !font-bold buy-now-btn transition-all">
                                Buy Now
                            </button>

                        </div>

                    </form>

                </mat-step>
            </mat-horizontal-stepper>
        </div>
    </div>
</div>
