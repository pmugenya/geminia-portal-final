<div class="export-shipment-modal">
    <h2 class="mb-4 text-2xl font-bold">
        {{ isExport ? 'Export Shipment Details' : 'High-Risk Shipment Details' }}
    </h2>

    <p class="mb-6 text-gray-600">
        {{ isExport
        ? 'Please provide the following details for your export request.'
        : 'Shipments from this origin require manual underwriting. Please provide your details to proceed.'
        }}
    </p>

    <form [formGroup]="isExport ? exportRequestForm : highRiskRequestForm" (ngSubmit)="isExport ? onExportRequestSubmit() : onHighRiskRequestSubmit()">

    <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
        <!-- Personal Information -->
        <div><label class="mb-2 block text-base font-medium">First Name <span class="text-red-500">*</span></label><input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onModalFirstNameInput($event, isExport ? 'export' : 'highRisk')" [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('firstName')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('firstName')?.touched) || !(isExport ? exportRequestForm : highRiskRequestForm).get('firstName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'"/></div>
        <div><label class="mb-2 block text-base font-medium">Last Name <span class="text-red-500">*</span></label><input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onModalLastNameInput($event, isExport ? 'export' : 'highRisk')" [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('lastName')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('lastName')?.touched) || !(isExport ? exportRequestForm : highRiskRequestForm).get('lastName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'"/></div>
        <div><label class="mb-2 block text-base font-medium">Email Address <span class="text-red-500">*</span></label><input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 text-base" (keydown)="preventSpaceInEmail($event)" (input)="onModalEmailInput($event, isExport ? 'export' : 'highRisk')" autocapitalize="off" autocomplete="email" autocorrect="off" spellcheck="false" inputmode="email" [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('email')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('email')?.touched) || !(isExport ? exportRequestForm : highRiskRequestForm).get('email')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'"/></div>
        <div><label class="mb-2 block text-base font-medium">Phone Number <span class="text-red-500">*</span></label><input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onModalPhoneNumberInput($event, isExport ? 'export' : 'highRisk')" [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('phoneNumber')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('phoneNumber')?.touched) || !(isExport ? exportRequestForm : highRiskRequestForm).get('phoneNumber')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'"/></div>

        <!-- Shipment Information -->
        <div>
            <label class="mb-2 block text-base font-medium">Country of Origin <span class="text-red-500">*</span></label>
            <!-- Always show Export-style readonly origin field -->
            <input type="text" formControlName="originCountry" class="w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-base font-semibold text-gray-900" readonly/>
        </div>

        <div>
            <label class="mb-2 block text-base font-medium">Destination Country <span class="text-red-500">*</span></label>
            <!-- Always show Export-style destination dropdown -->
            <select formControlName="destinationCountry" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-base font-semibold text-gray-900" [ngClass]="(exportRequestForm.get('destinationCountry')?.invalid && exportRequestForm.get('destinationCountry')?.touched) || !exportRequestForm.get('destinationCountry')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'">
                <option value="" disabled>Select a country</option>
                <option *ngFor="let country of exportDestinationCountries" [value]="country">{{ country }}</option>
            </select>
        </div>

        <div>
            <label class="mb-2 block text-base font-medium">Shipment Date <span class="text-red-500">*</span></label>
            <div class="relative w-full">
                <input
                    type="text"
                    matInput
                    [matDatepicker]="shipmentPicker"
                    formControlName="shipmentDate"
                    [min]="minDate"
                    readonly
                    (click)="shipmentPicker.open()"
                    class="w-full rounded-md border bg-white px-3 py-2 text-base"
                    [ngClass]="
                        ((isExport ? exportRequestForm : highRiskRequestForm).get('shipmentDate')?.invalid &&
                            (isExport ? exportRequestForm : highRiskRequestForm).get('shipmentDate')?.touched) ||
                        !(isExport ? exportRequestForm : highRiskRequestForm).get('shipmentDate')?.value
                            ? 'border-red-500 focus:ring-2 focus:ring-red-500'
                            : 'border-gray-300 focus:ring-2 focus:ring-primary'
                    " />
                <!-- Date selector icon -->
                <button
                    type="button"
                    (click)="shipmentPicker.open()"
                    class="absolute inset-y-0 right-3 flex items-center text-secondary hover:text-secondary focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 6a1 1 0 000 2h2a1 1 0 100-2H6zm5 1a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>
                <mat-datepicker #shipmentPicker></mat-datepicker>
            </div>
        </div>

        <div>
            <label class="mb-2 block text-base font-medium">Sum Insured (KES) <span class="text-red-500">*</span></label>
            <input type="text" formControlName="sumInsured" appThousands inputmode="numeric" class="w-full rounded-md border bg-white px-3 py-2 text-base" [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('sumInsured')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('sumInsured')?.touched) || !(isExport ? exportRequestForm : highRiskRequestForm).get('sumInsured')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'"/>
        </div>

        <div class="md:col-span-2 mt-4">
            <label class="mb-2 block text-base font-medium">Goods Description (Max 100 words) <span class="text-red-500">*</span></label>
            <textarea formControlName="goodsDescription" rows="3" placeholder="Describe the goods being shipped..." class="w-full rounded-md border bg-white px-3 py-2 text-base" style="min-height: 80px;" (blur)="trimInput($event, 'goodsDescription', isExport ? 'export' : 'highRisk')" [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('goodsDescription')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('goodsDescription')?.touched) || !(isExport ? exportRequestForm : highRiskRequestForm).get('goodsDescription')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-primary'"></textarea>
        </div>
    </div>

    <div
        class="mt-6 rounded-md px-3 py-3"
        [ngClass]="((isExport ? exportRequestForm : highRiskRequestForm).get('termsAndPolicyConsent')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('termsAndPolicyConsent')?.touched)
            ? 'border border-red-300 bg-red-50'
            : 'border border-gray-200 bg-white'">
        <label class="flex items-start">
            <input
                type="checkbox"
                formControlName="termsAndPolicyConsent"
                class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary" />
            <span class="ml-3 text-sm text-gray-700">
                I agree to the
                <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-gray-900">Terms of Use</a>
                and to the
                <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*
            </span>
        </label>
        <div
            *ngIf="(isExport ? exportRequestForm : highRiskRequestForm).get('termsAndPolicyConsent')?.invalid && (isExport ? exportRequestForm : highRiskRequestForm).get('termsAndPolicyConsent')?.touched"
            class="mt-1 text-xs text-red-600">
            You must agree to the Terms of Use and Data Privacy Policy to continue.
        </div>
    </div>
    <div class="mt-8 flex justify-end gap-4 pt-6">
        <button type="button" (click)="close()" class="rounded-md border border-gray-300 px-4 py-2 hover:bg-gray-50">Cancel</button>
        <button type="submit" [disabled]="(isExport ? exportRequestForm : highRiskRequestForm).invalid" class="btn-primary">Submit Request</button>
    </div>
    </form>

    <!-- Data Privacy Policy modal (cloned from quick quote style) -->
    <div *ngIf="showDataPrivacyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="mx-3 w-full max-w-3xl rounded-xl bg-white shadow-xl">
            <div class="flex items-center justify-between border-b px-3 py-3 sm:px-6 sm:py-4">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Data Privacy Policy</h2>
                <button type="button" (click)="closePrivacyModal()" class="text-gray-400 hover:text-gray-600 text-xl leading-none">Ã—</button>
            </div>
            <div class="px-3 py-4 sm:px-6 sm:py-6">
                <div class="prose max-w-none text-sm sm:text-base md:text-lg text-gray-700">
                    <p class="mb-3 sm:mb-4"><strong>Data Privacy Statement</strong></p>
                    <p class="mb-3 sm:mb-4">Geminia Insurance Company Limited is committed to protecting the fundamental human right to privacy of those with whom we interact. We recognize the need to safeguard personal data that is collected or disclosed to us as part of the Know-your-customer information required by us in order to provide you with the requisite financial product or service.</p>
                    <p class="mb-3 sm:mb-4">We are committed to complying with the requirements of the Data Protection Act and the attendant regulations as well as best global best practices regarding the processing of your personal data. In this regard, you are required to acquaint yourselves with our data privacy statement which is intended to tell you how we use your personal data and describes how we collect and process your personal data during and after your relationship with us.</p>

                    <div class="mt-4 sm:mt-6 rounded-md bg-green-50 px-3 py-3 sm:px-4 sm:py-4 text-xs sm:text-sm text-gray-800 border border-green-100">
                        <div class="font-semibold mb-1">External Link:</div>
                        <p>
                            For complete privacy policy details, please visit:
                            <a href="https://geminia.co.ke/data-privacy-statement/" target="_blank" class="text-sky-500 hover:underline break-all">https://geminia.co.ke/data-privacy-statement/</a>
                        </p>
                    </div>

                    <p class="mt-4 sm:mt-6 text-xs sm:text-sm text-gray-500">Last updated: {{ today | date:'dd/MM/yyyy' }}</p>
                </div>
            </div>
            <div class="sticky bottom-0 bg-white border-t border-gray-200 px-3 py-3 sm:px-6 sm:py-4 flex justify-end">
                <button type="button" (click)="closePrivacyModal()" class="rounded-md bg-primary px-3 py-2 sm:px-4 text-sm sm:text-base text-white hover:bg-secondary">I Understand</button>
            </div>
        </div>
    </div>
</div>
