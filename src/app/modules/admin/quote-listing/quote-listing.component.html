<div class="flex flex-col flex-auto w-full p-6 md:p-10">
    <fuse-alert
        name="quoteDownloadError"
        type="error"
        [dismissible]="true"
        [appearance]="'soft'">
        Failed to download quote. Please try again later.
    </fuse-alert>
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-[60vh] w-full">
        <mat-spinner diameter="60" color="primary"></mat-spinner>
        <p class="mt-4 text-gray-600 font-medium">Loading quote details...</p>
    </div>
    <div class="bg-card rounded-xl shadow w-full" *ngIf="!isLoading">
        <!-- Header -->
        <div class="p-6 border-b">
            <h2 class="text-xl font-semibold">My Quotes</h2>
        </div>

        <div class="p-6">
            <div class="bg-card rounded-xl shadow">
                <div class="flex items-center justify-between p-6 border-b">
                    <div>
                        <h3 class="text-lg font-semibold">My Quotes</h3>
                    </div>
                    <button
                        mat-flat-button
                        color="primary"
                        class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white hover:bg-secondary transition-colors"
                        (click)="openProductQuoteDialog()">
                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:plus'"></mat-icon>
                        <span class="ml-2">New Quote</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <div class="bg-card rounded-xl shadow">
                        <div class="text-secondary text-sm" *ngIf="!isInitialLoad">
                            Showing {{ myQuotesDataSource.data.length }} of {{ totalRecords }} Quotes
                        </div>
                        <!-- Loading State -->
                        <!--                            <div *ngIf="isLoading" class="flex justify-center items-center p-8">-->
                        <!--                                <mat-spinner diameter="40"></mat-spinner>-->
                        <!--                            </div>-->

                        <!-- Table -->
                        <div class="overflow-x-auto" *ngIf="!isLoading">
                            <table
                                class="w-full"
                                mat-table
                                matSort
                                [dataSource]="myQuotesDataSource"
                                [trackBy]="trackByFn"
                                #myQuotesTable>
                                <!-- Product Type -->
                                <ng-container matColumnDef="refno">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Ref No</th>
                                    <td mat-cell *matCellDef="let policy">
                                        <div class="flex items-center">
                                            {{ policy.refno }}
                                        </div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="clientName">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Client Name</th>
                                    <td mat-cell *matCellDef="let policy">
                                        <div class="flex items-center">
                                            {{ policy.clientName }}
                                        </div>
                                    </td>
                                </ng-container>
                                <!-- Insured Item -->
                                <ng-container matColumnDef="prodName">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Product</th>
                                    <td mat-cell *matCellDef="let policy">{{ policy.prodName }}</td>
                                </ng-container>
                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>Status</th>
                                    <td mat-cell *matCellDef="let policy">
                                        <span
                                            class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                                            [ngClass]="getPolicyStatusColor(policy.status)"
                                        >
                                            {{ policy.status }}
                                        </span>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="netprem">
                                    <th mat-header-cell *matHeaderCellDef>Premium</th>
                                    <td mat-cell *matCellDef="let policy">
                                        {{ policy.netprem | currency:'KES ' }}
                                    </td>

                                </ng-container>
                                <ng-container matColumnDef="sumassured">
                                    <th mat-header-cell *matHeaderCellDef>Sum Insured</th>
                                    <td mat-cell *matCellDef="let policy">
                                        {{ policy.sumassured | currency:'KES ' }}
                                    </td>

                                </ng-container>
                                <ng-container matColumnDef="expiryDates">
                                    <th mat-header-cell *matHeaderCellDef>Expiry Date</th>
                                    <td mat-cell *matCellDef="let policy">
                                        <div [class.text-red-600]="isExpiringSoon(policy.expiryDates)"
                                             [class.font-semibold]="isExpiringSoon(policy.expiryDates)">
                                            {{ formatDate(policy.expiryDates) }}
                                            <div class="text-xs text-secondary" *ngIf="isExpiringSoon(policy.expiryDates)">
                                                {{ getDaysUntilRenewal(policy.expiryDates) }} days left
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>


                                <!-- Empty State -->
                                <ng-container *ngIf="myQuotesDataSource.data.length === 0 && !isInitialLoad">
                                    <tr class="no-data-row">
                                        <td colspan="7" class="text-center py-8 text-gray-500">
                                            <mat-icon class="icon-size-12 mx-auto mb-2 text-gray-300" [svgIcon]="'heroicons_outline:document-magnifying-glass'"></mat-icon>
                                            <div class="text-lg font-medium">No policies found</div>
                                            <div class="text-sm">Try adjusting your search or filters</div>
                                        </td>
                                    </tr>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                                    <td mat-cell *matCellDef="let policy">
                                        <div class="flex flex-wrap gap-2">
                                            <button
                                                mat-stroked-button
                                                color="primary"
                                                class="px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1"
                                                (click)="viewQuote(policy)">
                                                <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:eye'"></mat-icon>
                                                <span>View Quote</span>
                                            </button>
                                            <button
                                                mat-stroked-button
                                                color="primary"
                                                class="px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1"
                                                (click)="downloadQuote(policy)">
                                                <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:arrow-down-tray'"></mat-icon>
                                                <span>Download Quote</span>
                                            </button>
                                        </div>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="myQuotesTableColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: myQuotesTableColumns;"></tr>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <mat-paginator
                            *ngIf="!isInitialLoad && totalRecords > 0"
                            [length]="totalRecords"
                            [pageSize]="quotesPageSize"
                            [pageSizeOptions]="pageSizeOptions"
                            [pageIndex]="currentPage"
                            (page)="onPageChange($event)"
                            showFirstLastButtons="true"
                        >
                        </mat-paginator>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
