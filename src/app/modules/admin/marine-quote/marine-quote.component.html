<div class="flex flex-col flex-auto w-full p-6 md:p-10">
    <div class="bg-card rounded-xl shadow w-full">
        <!-- Header -->
        <div class="p-6 border-b flex items-center justify-between">
            <h2 class="text-xl font-semibold">Marine Quote Details</h2>

            <button
                type="button"
                (click)="goToDashboard()"
                class="inline-flex items-center gap-2 px-4 py-1 rounded-full border text-sm font-medium bg-white header-close-btn">
                <span class="text-base font-normal" aria-hidden="true">&times;</span>
                <span>Close</span>
            </button>
        </div>

        <!-- Stepper -->
        <div class="p-6">
            <mat-horizontal-stepper [linear]="true" #stepper class="w-full" (selectionChange)="onStepChange($event)">
                <!-- Step 1 -->
                <mat-step [stepControl]="quotationForm">
                    <ng-template matStepLabel>Shipment Details</ng-template>
                    <form [formGroup]="quotationForm" class="space-y-6 w-full">
                        <fuse-alert
                            *ngIf="submissionError"
                            [title]="'Submission Failed!'"
                            [type]="'error'"
                            [dismissible]="true"
                            (dismiss)="submissionError = null">
                            {{ submissionError }}
                        </fuse-alert>

                        <h3 *ngIf="user.userType==='A'" class="mb-3 sm:mb-4 text-lg sm:text-xl font-semibold text-gray-800">Client Information</h3>

                        <div *ngIf="user.userType==='A'" class="mb-6 rounded-lg border border-gray-200 bg-white p-4">

                            <!-- Search by KRA PIN -->
                            <div class="mb-4 flex items-center gap-2">
                                <input
                                    type="text"
                                    placeholder="Search by KRA PIN..."
                                    class="w-64 rounded-md border border-gray-300 px-3 py-2"
                                    formControlName="searchPin"
                                />
                                <button
                                    type="button"
                                    mat-flat-button
                                    color="primary"
                                    (click)="searchClientByPin()"
                                    class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all">
                                    Search
                                </button>
                            </div>
                            <hr class="my-6 border-gray-300"/>

                            <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">First Name <span class="text-red-500">*</span></label>
                                    <input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 text-base"/>
                                </div>
                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
                                    <input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 text-base"/>
                                </div>
                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label>
                                    <input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 text-base email-input"/>
                                </div>
                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Phone Number <span class="text-red-500">*</span></label>
                                    <input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 text-base"/>
                                </div>
                            </div>
                        </div>


                        <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                            <!-- Mode of Shipment -->
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">
                                    Mode of Shipment <span class="text-red-500">*</span>
                                </label>
                                <mat-form-field appearance="outline" class="w-full mat-small">
                                    <mat-select formControlName="modeOfShipment">
                                        <mat-option value="" disabled>Select mode</mat-option>
                                        <mat-option value="1">Sea</mat-option>
                                        <mat-option value="2">Air</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Trade Type -->
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">
                                    Trade Type <span class="text-red-500">*</span>
                                </label>
                                <mat-form-field appearance="outline" class="w-full mat-small">
                                    <mat-select formControlName="tradeType">
                                        <mat-option value="" disabled>Select trade type</mat-option>
                                        <mat-option value="1">Import</mat-option>
                                        <mat-option value="2">Export</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>


                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Cargo Protection -->
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">Cargo Protection</label>
                                <input
                                    type="text"
                                    formControlName="marineProduct"
                                    class="w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 font-bold text-gray-900 h-12"
                                    readonly
                                />
                            </div>

                            <!-- Marine Packaging Type -->
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">
                                    Marine Packaging Type <span class="text-red-500">*</span>
                                </label>

                                <mat-radio-group
                                    formControlName="marinePackagingType"
                                    class="flex flex-col sm:flex-row gap-1 sm:gap-2 items-start sm:items-center px-3 py-0.5 rounded-md border text-gray-700"
                                    [ngClass]="
        quotationForm.get('marinePackagingType')?.invalid &&
        quotationForm.get('marinePackagingType')?.touched
          ? 'border-red-500 bg-red-50'
          : 'border-gray-300 bg-white'
      "
                                >
                                    <mat-radio-button
                                        value="1"
                                        class="m-0 flex items-center text-sm"
                                        style="padding: 0 0.25rem;"
                                    >
                                        Containerized
                                    </mat-radio-button>

                                    <mat-radio-button
                                        value="2"
                                        class="m-0 flex items-center text-sm"
                                        style="padding: 0 0.25rem;"
                                    >
                                        Non-Containerized
                                    </mat-radio-button>
                                </mat-radio-group>


                            </div>
                        </div>




                        <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                            <!-- Select Category -->
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">Select Category <span class="text-red-500">*</span></label>
                                <mat-form-field appearance="outline" class="w-full category-select mat-small">
                                    <mat-select formControlName="marineCategory" (selectionChange)="onCategorySelected($event.value)" #categorySelect>
                                        <mat-option>
                                            <ngx-mat-select-search [formControl]="categoryFilterCtrl" placeholderLabel="Search categories..."></ngx-mat-select-search>
                                        </mat-option>
                                        <mat-option *ngFor="let category of filteredMarineCategories" [value]="category.catname">
                                            {{ category.catname }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Marine Cargo Type -->
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-2">Marine Cargo Type <span class="text-red-500">*</span></label>
                                <mat-form-field appearance="outline" class="w-full cargo-type-select mat-small">
                                    <mat-select formControlName="marineCargoType" (selectionChange)="onCategoryTypeSelected($event.value)"
                                                #cargoTypeSelect [disabled]="isLoadingCargoTypes">
                                        <mat-option>
                                            <ngx-mat-select-search [formControl]="cargoTypeFilterCtrl" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                                        </mat-option>
                                        <mat-option *ngFor="let type of filteredMarineCargoTypes" [value]="type.ctname">
                                            {{ type.ctname }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>


                        <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                <!-- Updated Country of Origin with Searchable Dropdown -->
                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Country of Origin <span class="text-red-500">*</span></label>
                                    <mat-form-field appearance="outline" class="w-full country-select">
                                        <mat-select formControlName="origin" #countrySelect2
                                                    (openedChange)="onSelectOpen($event)"
                                                    (selectionChange)="onOriginChange($event)"
                                                    (scroll)="onScroll($event)"
                                                    [disabled]="loading">
                                            <div class="search-container flex items-center px-2" (click)="$event.stopPropagation()">
                                                <mat-icon class="text-gray-400">search</mat-icon>
                                                <input
                                                    matInput
                                                    type="text"
                                                    placeholder="Search..."
                                                    [formControl]="countryFilterCtrl"
                                                    (keydown)="$event.stopPropagation()"
                                                />
                                            </div>

                                            <mat-option *ngFor="let country of countries" [value]="country.id">
                                                {{ country.countryname }}
                                            </mat-option>

                                            <mat-option *ngIf="loading">
                                                <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>


                                </div>

                                <div>
                                    <label class="mb-2 block text-base font-medium text-gray-700">Destination</label>
                                    <input type="text" formControlName="destination" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2 text-gray-900 h-14" readonly/>
                                </div>
                            </div>

                            <div class="mb-6">
                                <label class="mb-2 block text-base font-medium text-gray-700">Sum Insured (KES) <span class="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    formControlName="sumInsured"
                                    appThousands
                                    placeholder="00.00"
                                    inputmode="numeric"
                                    class="w-full rounded-md border bg-white px-3 py-2 text-base h-12 sum-insured-input"
                                    [ngClass]="(quotationForm.get('sumInsured')?.invalid && quotationForm.get('sumInsured')?.touched) || !quotationForm.get('sumInsured')?.value ? 'border-red-500' : 'border-gray-300'"
                                />
                            </div>

                        <!-- Terms and Policy Consent -->
                        <div class="mt-6 space-y-2"
                             [ngClass]="quotationForm.get('termsAndPolicyConsent')?.invalid && quotationForm.get('termsAndPolicyConsent')?.touched ? 'border border-red-500 bg-red-50 rounded-md p-3' : ''">
                            <label class="flex items-start">
                                <input
                                    type="checkbox"
                                    formControlName="termsAndPolicyConsent"
                                    class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary"/>
                                <span class="ml-3 text-sm text-gray-700">
                                    I agree to the
                                    <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Terms of Use</a>
                                    and to the
                                    <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*
                                </span>
                            </label>
                            <p
                                *ngIf="quotationForm.get('termsAndPolicyConsent')?.invalid && quotationForm.get('termsAndPolicyConsent')?.touched"
                                class="text-xs text-red-600 mt-1">
                                You must agree to the Terms of Use and Data Privacy Policy to continue.
                            </p>
                        </div>

                        <div class="flex justify-end mt-6">
                            <button
                                mat-flat-button
                                color="primary"
                                (click)="submitQuotation()"
                                class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all">
                                Next
                            </button>
                        </div>
                    </form>
                </mat-step>

                <!-- Step 2 -->
                <!-- Step 2 -->
                <mat-step [stepControl]="coverageFormGroup">
                    <ng-template matStepLabel>Marine Quote Details</ng-template>
                    <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-[60vh] w-full">
                        <mat-spinner diameter="60" color="primary"></mat-spinner>
                        <p class="mt-4 text-gray-600 font-medium">Loading quote details...</p>
                    </div>

                    <form [formGroup]="coverageFormGroup" class="space-y-6 w-full max-w-4xl mx-auto">

                        <fuse-alert
                            name="quoteDownloadError"
                            type="error"
                            [dismissible]="true"
                            [appearance]="'soft'">
                            Failed to download quote. Please try again later.
                        </fuse-alert>

                        <!-- Step Title -->

                        <div class="flex items-center justify-between border-b pb-4 mb-6" *ngIf="!isLoading && quote">
                            <div>
                                <h2 class="text-2xl font-semibold leading-8 tracking-tight">
                                    Quote Details
                                </h2>
                                <div class="text-secondary text-sm font-medium tracking-tight">
                                    Reference: <span class="reference-pill">{{ quote?.refno }}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button
                                    mat-flat-button
                                    color="primary"
                                    class="buy-now-btn"
                                    (click)="stepper.next()">
                                    Buy Now
                                </button>
                                <button
                                    mat-flat-button
                                    color="primary"
                                    class="download-btn"
                                    (click)="downloadQuote()">
                                    <mat-icon svgIcon="heroicons_outline:arrow-down-tray" class="mr-2"></mat-icon>
                                    Download Quote
                                </button>
                                <button
                                    type="button"
                                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-sm font-medium bg-white text-gray-700 hover:bg-gray-50 share-trigger-btn"
                                    (click)="openShareDialog()">
                                    <mat-icon class="icon-size-4">share</mat-icon>
                                    <span>Share Quote</span>
                                </button>
                            </div>
                        </div>

                        <!-- Basic Info Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-card rounded-xl shadow p-5">
                                <h3 class="text-sm font-medium text-secondary mb-2">Customer</h3>
                                <div class="text-lg font-semibold">{{ quote?.firstName }} {{ quote?.lastName }}</div>
                                <div class="text-sm text-secondary">{{ quote?.email }}</div>
                                <div class="text-sm text-secondary">{{ quote?.phoneNo }}</div>
                            </div>

                            <div class="bg-card rounded-xl shadow p-5">
                                <h3 class="text-sm font-medium text-secondary mb-2">Category & Product</h3>
                                <div class="text-lg font-semibold">{{ quote?.category }}</div>
                                <div class="text-sm text-secondary">{{ quote?.prodName }}</div>
                            </div>

                            <div class="bg-card rounded-xl shadow p-5">
                                <h3 class="text-sm font-medium text-secondary mb-2">Status</h3>
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium"
                                      [ngClass]="getStatusColor(quote?.status)">{{ quote?.status }}</span>
                                <div class="text-sm text-secondary mt-2">
                                    Expires on: <span class="font-medium">{{ quote?.expiryDate | date }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping & Cargo Details -->
                        <div class="bg-card rounded-xl shadow p-6 mt-8">
                            <h3 class="text-lg font-semibold mb-4">Shipping & Cargo Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Swapped: show Cargo Type first -->
                                <div>
                                    <label class="text-sm text-secondary">Cargo Type</label>
                                    <div class="font-medium">{{ quote?.cargotype }}</div>
                                </div>
                                <!-- Swapped: show Shipping Mode next -->
                                <div>
                                    <label class="text-sm text-secondary">Shipping Mode</label>
                                    <div class="font-medium">{{ quote?.shippingmode }}</div>
                                </div>
                                <!-- Vessel hidden; use this slot for Packaging Type -->
                                <div>
                                    <label class="text-sm text-secondary">Packaging Type</label>
                                    <div class="font-medium">{{ quote?.packagingtype }}</div>
                                </div>
                                <!-- Origin Country moved down -->
                                <div>
                                    <label class="text-sm text-secondary">Origin Country</label>
                                    <div class="font-medium">{{ quote?.originId }}</div>
                                </div>
                                <!-- Destination moved down -->
                                <div>
                                    <label class="text-sm text-secondary">Destination</label>
                                    <div class="font-medium">{{ quote?.destination }}</div>
                                </div>
                                <!-- Original Packaging/Vessel slot now hidden -->
                                <div *ngIf="false">
                                    <label class="text-sm text-secondary">Vessel Name</label>
                                    <div class="font-medium">{{ quote?.vesselName }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="bg-card rounded-xl shadow p-6 mt-8">
                            <h3 class="text-lg font-semibold mb-4">Premium Details</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                <div>
                                    <label class="text-sm text-secondary">Sum Assured</label>
                                    <div class="font-medium">{{ quote?.sumassured | currency:'KES ' }}</div>
                                </div>
                                <div>
                                    <label class="text-sm text-secondary">Premium</label>
                                    <div class="font-medium">{{ quote?.premium | currency:'KES ' }}</div>
                                </div>
                                <div>
                                    <label class="text-sm text-secondary">PHCF</label>
                                    <div class="font-medium">{{ quote?.phcf | currency:'KES ' }}</div>
                                </div>
                                <div>
                                    <label class="text-sm text-secondary">Training Levy</label>
                                    <div class="font-medium">{{ quote?.traininglevy | currency:'KES ' }}</div>
                                </div>
                                <div>
                                    <label class="text-sm text-secondary">Stamp Duty</label>
                                    <div class="font-medium">{{ quote?.sd | currency:'KES ' }}</div>
                                </div>
                                <div>
                                    <div class="flex items-center text-sm text-secondary">
                                        <span>Net Premium</span>
                                        <span class="net-premium-amount">{{ quote?.netprem | currency:'KES ' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Supporting Documents -->

                        <!-- Description Section -->
                        <div class="bg-card rounded-xl shadow p-6 mt-8" *ngIf="false">
                            <h3 class="text-lg font-semibold mb-3">Description</h3>
                            <p class="text-secondary text-sm leading-relaxed">
                                {{ quote?.description || 'No description provided for this quote.' }}
                            </p>
                        </div>


                        <!-- Navigation Buttons -->
                        <div class="flex flex-col sm:flex-row justify-between mt-6 gap-3">
                            <button
                                mat-stroked-button
                                (click)="stepper.previous()"
                                class="w-full sm:w-auto px-8 py-3 rounded-lg shadow-sm text-base back-btn-step2 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all">
                                Back
                            </button>
                        </div>

                    </form>
                </mat-step>



                <!-- Step 3 -->
                <!-- Step 3 - Updated with better payment flow -->
                <mat-step>
                    <ng-template matStepLabel>Marine Details & Payment</ng-template>

                    <form [formGroup]="shipmentForm" class="space-y-6 w-full max-w-7xl mx-auto">

                        <!-- Step Title -->
                        <div class="mb-6">
                            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 text-center sm:text-left">
                                {{ !applicationSubmitted ? 'Provide Marine Details to Submit' : 'Complete Your Payment' }}
                            </h2>
                            <p class="text-gray-600 mt-2" *ngIf="!applicationSubmitted">
                                Fill in the required information and submit your application
                            </p>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

                            <!-- Left Column - Form Fields (Hidden after submission) -->
                            <div class="lg:col-span-7" [class.readonly-section]="applicationSubmitted">

                                <!-- Document Uploads Section -->
                                <div class="mb-4 p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;">
                                    <h2 class="text-sm font-semibold text-gray-900 mb-3">Document Uploads</h2>

                                    <!-- IDF Document & Invoice -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <!-- IDF Document -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                IDF Document <span class="text-red-500">*</span>
                                            </label>
                                            <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                                 [ngClass]="duplicateFileErrors['idfDocument'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('idfDocument')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400 hover:bg-blue-50')"
                                                 (click)="idfDocument.click()">
                                                <button type="button" mat-button color="primary">Choose file</button>
                                                <input hidden #idfDocument type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'idfDocument')">
                                                <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('idfDocument').value?.name || 'No file chosen' }}</p>
                                                <p class="text-xs text-gray-400 mt-1">PDF, JPG, PNG (Max 500KB)</p>
                                            </div>
                                            <p *ngIf="duplicateFileErrors['idfDocument']" class="mt-1 text-xs text-red-600 text-left">
                                                {{ duplicateFileErrors['idfDocument'] }}
                                            </p>
                                        </div>

                                        <!-- Invoice -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                Invoice <span class="text-red-500">*</span>
                                            </label>
                                            <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                                 [ngClass]="duplicateFileErrors['invoice'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('invoice')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400 hover:bg-blue-50')"
                                                 (click)="invoice.click()">
                                                <button type="button" mat-button color="primary">Choose file</button>
                                                <input hidden #invoice type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'invoice')">
                                                <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('invoice').value?.name || 'No file chosen' }}</p>
                                                <p class="text-xs text-gray-400 mt-1">PDF, JPG, PNG (Max 500KB)</p>
                                            </div>
                                            <p *ngIf="duplicateFileErrors['invoice']" class="mt-1 text-xs text-red-600 text-left">
                                                {{ duplicateFileErrors['invoice'] }}
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Conditional Documents (KRA & National ID) -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3" *ngIf="userDocs">
                                        <!-- KRA PIN Certificate -->
                                        <div *ngIf="!userDocs.kraDocumentExists">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                KRA PIN Certificate <span class="text-red-500">*</span>
                                            </label>
                                            <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                                 [ngClass]="duplicateFileErrors['kraPinCertificate'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('kraPinCertificate')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400')"
                                                 (click)="kraPinCertificate.click()">
                                                <button type="button" mat-button color="primary">Choose file</button>
                                                <input hidden #kraPinCertificate type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'kraPinCertificate')">
                                                <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('kraPinCertificate').value?.name || 'No file chosen' }}</p>
                                            </div>
                                            <p *ngIf="duplicateFileErrors['kraPinCertificate']" class="mt-1 text-xs text-red-600 text-left">
                                                {{ duplicateFileErrors['kraPinCertificate'] }}
                                            </p>
                                        </div>

                                        <!-- National ID -->
                                        <div *ngIf="!userDocs.idfDocumentExists">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                National ID <span class="text-red-500">*</span>
                                            </label>
                                            <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                                 [ngClass]="duplicateFileErrors['nationalId'] ? 'border-red-500 bg-red-50' : (!shipmentForm.get('nationalId')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400')"
                                                 (click)="nationalId.click()">
                                                <button type="button" mat-button color="primary">Choose file</button>
                                                <input hidden #nationalId type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'nationalId')">
                                                <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('nationalId').value?.name || 'No file chosen' }}</p>
                                            </div>
                                            <p *ngIf="duplicateFileErrors['nationalId']" class="mt-1 text-xs text-red-600 text-left">
                                                {{ duplicateFileErrors['nationalId'] }}
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Terms Checkbox -->
                                    <div class="mt-3"
                                         [ngClass]="shipmentForm.get('agreeToTerms')?.invalid && shipmentForm.get('agreeToTerms')?.touched ? 'border border-red-500 bg-red-50 rounded-md p-3' : ''">
                                        <div class="flex items-start">
                                            <mat-checkbox formControlName="agreeToTerms" color="primary"></mat-checkbox>
                                            <label class="text-sm text-gray-600 ml-2">
                                                I agree to the
                                                <a (click)="openTermsOfUse($event)" class="hover:underline cursor-pointer" style="color: #04b2e1;">Terms of Use</a>
                                                and
                                                <a (click)="openPrivacyPolicy($event)" class="hover:underline cursor-pointer" style="color: #04b2e1;">Privacy Policy</a>
                                            </label>
                                        </div>
                                        <p
                                            *ngIf="shipmentForm.get('agreeToTerms')?.invalid && shipmentForm.get('agreeToTerms')?.touched"
                                            class="text-xs text-red-600 mt-1">
                                            You must agree to the Terms of Use and Privacy Policy to continue.
                                        </p>
                                    </div>
                                </div>

                                <!-- Personal Information -->
                                <div class="mb-4 p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;">
                                    <h2 class="text-sm font-semibold text-gray-900 mb-3">Personal Information</h2>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Number *</label>
                                            <input class="w-full px-3 py-2 border rounded-md special-focus-field"
                                                   [ngClass]="!shipmentForm.get('idNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                                   formControlName="idNumber"
                                                   placeholder="Enter ID number"
                                                   maxlength="10">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">KRA PIN *</label>
                                            <input class="w-full px-3 py-2 border rounded-md uppercase special-focus-field"
                                                   [ngClass]="!shipmentForm.get('kraPin')?.value ? 'border-red-500' : 'border-gray-300'"
                                                   formControlName="kraPin"
                                                   placeholder="Enter KRA PIN"
                                                   maxlength="11">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                            <input class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                                   formControlName="firstName" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                            <input class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                                   formControlName="lastName" readonly>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                                            <input class="w-full px-3 py-2 border rounded-md"
                                                   [ngClass]="!shipmentForm.get('emailAddress')?.value ? 'border-red-500' : 'border-gray-300'"
                                                   formControlName="emailAddress"
                                                   type="email">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                            <input class="w-full px-3 py-2 border rounded-md bg-gray-100"
                                                   [ngClass]="!shipmentForm.get('phoneNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                                   formControlName="phoneNumber"
                                                   maxlength="10"
                                                   readonly>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Postal Address *</label>
                                            <input class="w-full px-3 py-2 border rounded-md"
                                                   [ngClass]="!shipmentForm.get('streetAddress')?.value ? 'border-red-500' : 'border-gray-300'"
                                                   formControlName="streetAddress"
                                                   type="text">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Postal Code *</label>
                                            <select
                                                class="w-full px-3 py-2 border rounded-md special-focus-field"
                                                [ngClass]="!shipmentForm.get('postalCode')?.value ? 'border-red-500' : 'border-gray-300'"
                                                formControlName="postalCode">
                                                <option value="">Select postal code</option>
                                                <option *ngFor="let pc of postalCodes"
                                                        [value]="pc.id">
                                                    {{ pc.postalCode }} - {{ pc.postalTown }}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shipment Details -->
                                <div class="mb-4 p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;">
                                    <h2 class="text-sm font-semibold text-gray-900 mb-3">Shipment Details</h2>

                                    <!-- Add all your shipment detail fields here (mode, trade type, vessel, etc.) -->
                                    <!-- Keeping the structure you already have -->

                                    <div class="flex flex-wrap items-end gap-4 mb-3">
                                        <div class="flex-1 min-w-[200px]">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Mode of Shipment *</label>
                                            <select
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                formControlName="modeOfShipment">
                                                <option value="">Select mode</option>
                                                <option value="1">Sea</option>
                                                <option value="2">Air</option>
                                            </select>
                                        </div>

                                        <div class="flex-1 min-w-[200px]">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Trade Type</label>
                                            <input
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                                formControlName="tradeType"
                                                value="Marine Cargo Import"
                                                readonly>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="block text-base font-medium text-gray-700 mb-2">Marine Packaging Type</label>
                                        <mat-radio-group formControlName="commodityType" color="primary">
                                            <mat-radio-button value="1" class="mr-4">Containerized</mat-radio-button>
                                            <mat-radio-button value="2">Non-Containerized</mat-radio-button>
                                        </mat-radio-group>
                                    </div>

                                    <!-- Sum Insured (Full Width) -->
                                    <div class="mb-3">
                                        <label class="block text-base font-medium text-gray-700 mb-1">Sum Insured (KES) *</label>
                                        <input [class]="'w-full px-3 py-2 border rounded-md bg-gray-100 ' +
                       (!shipmentForm.get('sumInsured')?.value ?
                       'border-red-500' : 'border-gray-300')"
                                               type="text"
                                               formControlName="sumInsured"
                                               appThousands
                                               placeholder="Enter sum insured amount"
                                               inputmode="numeric"
                                               >
                                    </div>

                                    <!-- Select Category | Cargo Type -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-base font-medium text-gray-700 mb-1">Select Category *</label>
                                            <mat-form-field appearance="outline" class="w-full category-select mat-small"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('selectCategory')?.invalid && shipmentForm.get('selectCategory')?.touched) || !shipmentForm.get('selectCategory')?.value}">
                                                <mat-select formControlName="selectCategory" (selectionChange)="onCategorySelected2($event.value)" #categorySelect2>
                                                    <mat-option>
                                                        <ngx-mat-select-search [formControl]="categoryFilterCtrl2" placeholderLabel="Search categories..."></ngx-mat-select-search>
                                                    </mat-option>
                                                    <mat-option *ngFor="let category of filteredMarineCategories" [value]="category.catname">
                                                        {{ category.catname }}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                        <div>
                                            <label class="block text-base font-medium text-gray-700 mb-1">Cargo Type *</label>
                                            <mat-form-field appearance="outline" class="w-full cargo-type-select mat-small"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('salesCategory')?.invalid && shipmentForm.get('salesCategory')?.touched) || !shipmentForm.get('salesCategory')?.value}">
                                                <mat-select formControlName="salesCategory" #cargoTypeSelect  (selectionChange)="onCategoryTypeSelected2($event.value)"
                                                            [disabled]="isLoadingCargoTypes">
                                                    <mat-option>
                                                        <ngx-mat-select-search [formControl]="cargoTypeFilterCtrl2" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                                                    </mat-option>
                                                    <mat-option *ngFor="let type of filteredMarineCargoTypes" [value]="type.ctname">
                                                        {{ type.ctname }}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <!-- Vessel Name | IDF Number -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-base font-medium text-gray-700 mb-1">Vessel Name</label>
                                            <input [class]="'w-full px-3 py-2 border rounded-md special-focus-field ' +
                           ((shipmentForm.get('vesselName')?.invalid && shipmentForm.get('vesselName')?.touched) ?
                           'border-red-500' : 'border-gray-300')"
                                                   formControlName="vesselName"
                                                   placeholder="Enter the vessel name"
                                                   (input)="onVesselNameInput($event)">
                                        </div>
                                        <div>
                                            <label class="block text-base font-medium text-gray-700 mb-1">
                                                IDF Number *
                                            </label>
                                            <input [class]="'w-full px-3 py-2 border rounded-md special-focus-field ' +
                           ((shipmentForm.get('gcrNumber')?.invalid && shipmentForm.get('gcrNumber')?.touched) || !shipmentForm.get('gcrNumber')?.value ?
                           'border-red-500' : 'border-gray-300') +
                           (shipmentForm.get('gcrNumber')?.value ? ' font-bold' : '')"
                                                   formControlName="gcrNumber"
                                                   placeholder="Enter IDF number"
                                                   maxlength="16"
                                                   style="text-transform: uppercase;"
                                                   (input)="onIdfNumberInput($event)">
                                        </div>
                                    </div>

                                    <!-- Date of Dispatch | Estimated Time of Arrival -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-base font-medium text-gray-700 mb-1">Date of Dispatch *</label>
                                            <mat-form-field appearance="outline" class="w-full" style="min-height: 50px;"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('dateOfDispatch')?.invalid && shipmentForm.get('dateOfDispatch')?.touched) || !shipmentForm.get('dateOfDispatch')?.value}">
                                                <input matInput [matDatepicker]="dispatchPicker" formControlName="dateOfDispatch" [min]="today" readonly>
                                                <mat-datepicker-toggle matSuffix [for]="dispatchPicker"></mat-datepicker-toggle>
                                                <mat-datepicker #dispatchPicker></mat-datepicker>
                                            </mat-form-field>
                                        </div>
                                        <div>
                                            <label class="block text-base font-medium text-gray-700 mb-1">Date of Arrival *</label>
                                            <mat-form-field appearance="outline" class="w-full" style="min-height: 50px;"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('estimatedArrival')?.invalid && shipmentForm.get('estimatedArrival')?.touched) || !shipmentForm.get('estimatedArrival')?.value}">
                                                <input matInput [matDatepicker]="arrivalPicker" formControlName="estimatedArrival" [min]="shipmentForm.get('dateOfDispatch')?.value || today" readonly>
                                                <mat-datepicker-toggle matSuffix [for]="arrivalPicker"></mat-datepicker-toggle>
                                                <mat-datepicker #arrivalPicker></mat-datepicker>
                                                <mat-error *ngIf="shipmentForm.get('estimatedArrival')?.hasError('beforeDispatch')">
                                                    Date of Arrival cannot be before Date of Dispatch
                                                </mat-error>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <!-- Country of Origin | Loading Port -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Country of Origin *</label>
                                            <mat-form-field appearance="outline" class="w-full shipping-select" style="min-height: 50px;"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('countryOfOrigin')?.invalid && shipmentForm.get('countryOfOrigin')?.touched) || !shipmentForm.get('countryOfOrigin')?.value}">

                                                <mat-select formControlName="countryOfOrigin" #countrySelect [compareWith]="compareCountries"
                                                            (openedChange)="onSelectOpen2($event)" (scroll)="onScrollLast($event)">

                                                    <mat-option>
                                                        <ngx-mat-select-search [formControl]="countryFilterCtrl2" placeholderLabel="Search countries..."></ngx-mat-select-search>
                                                    </mat-option>

                                                    <mat-option *ngFor="let country of origincountries" [value]="country">
                                                        {{ country.countryname }}
                                                    </mat-option>

                                                    <mat-option *ngIf="loading">
                                                        <mat-spinner diameter="20"></mat-spinner> Loading...
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>

                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Loading Port *</label>
                                            <mat-form-field appearance="outline" class="w-full shipping-select" style="min-height: 50px;"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('loadingPort')?.invalid && shipmentForm.get('loadingPort')?.touched) || !shipmentForm.get('loadingPort')?.value}">
                                                <mat-select formControlName="loadingPort"
                                                            #portSelect
                                                            (openedChange)="onSelectOpenPorts($event)"
                                                            (scroll)="onScrollPorts($event)">
                                                    <mat-option>
                                                        <ngx-mat-select-search [formControl]="loadingPortSearchCtrl" placeholderLabel="Search loading ports..."></ngx-mat-select-search>
                                                    </mat-option>
                                                    <mat-option *ngFor="let port of loadingPorts" [value]="port.id">
                                                        {{ port.portName }}
                                                    </mat-option>
                                                    <mat-option *ngIf="isLoadingLoadingPorts">
                                                        <mat-spinner diameter="20"></mat-spinner> Loading ports...
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <!-- Port of Discharge | Final Destination -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Port of Discharge *</label>
                                            <mat-form-field appearance="outline" class="w-full shipping-select" style="min-height: 50px;"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('portOfDischarge')?.invalid && shipmentForm.get('portOfDischarge')?.touched) || !shipmentForm.get('portOfDischarge')?.value}">
                                                <mat-select formControlName="portOfDischarge" (openedChange)="onDropdownOpen('dischargePorts')"
                                                            (scroll)="onDischargePortScroll()">
                                                    <mat-option>
                                                        <ngx-mat-select-search [formControl]="dischargePortSearchCtrl" placeholderLabel="Search discharge ports..."></ngx-mat-select-search>
                                                    </mat-option>
                                                    <mat-option *ngFor="let port of filteredDischargePorts | async" [value]="getPortId(port)">
                                                        {{ getPortDisplayName(port) }}
                                                    </mat-option>
                                                    <mat-option *ngIf="isLoadingDischargePorts" disabled>
                                                        <mat-spinner diameter="20"></mat-spinner> Loading ports...
                                                    </mat-option>
                                                    <mat-option *ngIf="(filteredDischargePorts | async)?.length === 0 && !isLoadingDischargePorts" disabled>
                                                        <em> Ports unavailable. Please contact support or try again later.</em>
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Final Destination *</label>
                                            <mat-form-field appearance="outline" class="w-full shipping-select" style="min-height: 50px;"
                                                            [ngClass]="{'mat-form-field-invalid': (shipmentForm.get('finalDestination')?.invalid && shipmentForm.get('finalDestination')?.touched) || !shipmentForm.get('finalDestination')?.value}">
                                                <mat-select formControlName="finalDestination">
                                                    <mat-option>
                                                        <ngx-mat-select-search [formControl]="countySearchCtrl" placeholderLabel="Search counties..."></ngx-mat-select-search>
                                                    </mat-option>
                                                    <mat-option *ngFor="let county of filteredCounties | async" [value]="county.id">
                                                        {{ county.portName }}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="block text-base font-medium text-gray-700 mb-1">Description of Goods *</label>
                                        <textarea [class]="'w-full px-3 py-2 border rounded-md goods-description-field ' +
                           (!shipmentForm.get('goodsDescription')?.value ?
                           'border-red-500' : 'border-gray-300')"
                                                  formControlName="goodsDescription"
                                                  placeholder="Enter description of goods"
                                                  rows="4"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column - Payment Summary (Always Visible) -->
                            <div class="lg:col-span-5">
                                <div class="bg-white rounded-lg shadow-lg border-2 p-6 sticky top-4 overflow-visible"
                                     [ngClass]="applicationSubmitted ? 'bg-green-50/30' : 'bg-orange-50/30'"
                                     style="border-color: #04b2e1;">

                                    <!-- Success Message (After Submission) -->
                                    <div *ngIf="applicationSubmitted" class="mb-6 p-4 bg-green-100 border border-green-400 rounded-lg">
                                        <div class="flex items-center mb-2">
                                            <mat-icon class="text-green-600 mr-2">check_circle</mat-icon>
                                            <h3 class="text-lg font-bold text-green-800">Application Submitted Successfully!</h3>
                                        </div>
                                        <p class="text-sm text-green-700">Your reference number: <strong>{{ paymentRefNo }}</strong></p>
                                    </div>

                                    <h2 class="text-xl font-semibold text-gray-900 mb-4 text-center">
                                        {{ applicationSubmitted ? 'Payment Details' : 'Payment Summary' }}
                                    </h2>

                                    <!-- Cargo Protection -->
                                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium">Cargo Protection</span>
                                            <mat-icon class="text-blue-600 text-sm">info</mat-icon>
                                        </div>
                                        <div class="mt-1">
                                            <span class="text-base font-semibold">{{ getCargoProtectionName() }}</span>
                                        </div>
                                    </div>

                                    <!-- Payment Breakdown -->
                                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200" *ngIf="quoteResult">
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">Sum Insured:</span>
                                                <span class="font-semibold">KES {{ formatAmount(shipmentForm.get('sumInsured')?.value || 0) }}</span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">Basic Premium:</span>
                                                <span class="font-semibold">KES {{ formatAmount(quoteResult.premium) }}</span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">PHCF (0.25%):</span>
                                                <span class="font-semibold">KES {{ formatAmount(quoteResult.phcf) }}</span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">Training Levy (0.2%):</span>
                                                <span class="font-semibold">KES {{ formatAmount(quoteResult.tl) }}</span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">Stamp Duty:</span>
                                                <span class="font-semibold">KES {{ formatAmount(quoteResult.sd) }}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Total Amount -->
                                    <div class="mb-6 p-4 rounded-lg" *ngIf="quoteResult" style="background-color: #21275c;">
                                        <div class="flex justify-between items-center text-white">
                                            <span class="text-lg font-bold">Total Payable:</span>
                                            <span class="text-2xl font-bold">KES {{ quoteResult.netprem | number:'1.2-2' }}</span>
                                        </div>
                                    </div>

                                    <!-- Payment Instructions (After Submission) -->
                                    <div *ngIf="applicationSubmitted" class="space-y-4">
                                        <div class="p-4 bg-white rounded-lg border-2 border-blue-300">
                                            <h3 class="font-bold text-gray-900 mb-3 flex items-center">
                                                <mat-icon class="text-blue-600 mr-2">payment</mat-icon>
                                                M-PESA Payment Instructions
                                            </h3>

                                            <div class="space-y-3">
                                                <div class="flex justify-between p-2 bg-gray-50 rounded">
                                                    <span class="text-gray-700">Paybill Number:</span>
                                                    <span class="font-bold text-gray-900">553201</span>
                                                </div>

                                                <div class="flex justify-between p-2 bg-gray-50 rounded">
                                                    <span class="text-gray-700">Account Number:</span>
                                                    <span class="font-bold text-gray-900">{{ paymentRefNo }}</span>
                                                </div>

                                                <div class="mt-4">
                                                    <label class="block text-sm font-medium text-gray-700 mb-2" style="color: #21275c;">
                                                        Enter M-PESA Number *
                                                    </label>
                                                    <input
                                                        class="w-full px-3 py-2 border rounded-md mpesa-input"
                                                        [ngClass]="!shipmentForm.get('mpesaNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                                        formControlName="mpesaNumber"
                                                        placeholder="07XX XXX XXX"
                                                        maxlength="10"
                                                        (input)="onMpesaNumberInput($event)">
                                                    <p class="text-xs mt-1" style="color: #21275c;">Enter the M-PESA number to receive the payment prompt</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Button -->
                                    <button
                                        mat-raised-button
                                        color="primary"
                                        class="w-full py-3 text-lg font-semibold rounded-full flex items-center justify-center"
                                        [disabled]="isProcessPayment || !shipmentForm.get('mpesaNumber')?.value"
                                        (click)="initiatePayment()"
                                        style="background-color: #21275c; color: #ffffff;">
                                        <span *ngIf="!isProcessPayment">
                                            Send Payment Prompt
                                        </span>
                                        <mat-spinner *ngIf="isProcessPayment" diameter="24" class="payment-spinner"></mat-spinner>
                                    </button>

                                        <p class="text-xs text-center mt-2" style="color: #21275c;">
                                            You will receive an M-PESA prompt on your phone. Enter your PIN to complete the payment.
                                        </p>
                                    </div>

                                    <!-- Submit Application Button (Before Submission) -->
                                    <div *ngIf="!applicationSubmitted">
                                        <button
                                            mat-raised-button
                                            color="primary"
                                            class="w-full py-3 text-lg font-semibold rounded-full"
                                            [disabled]="isSubmitting"
                                            (click)="onSubmit()"
                                            style="background-color: #21275c; color: #ffffff;">
                                            <mat-spinner *ngIf="isSubmitting" diameter="24" class="mr-2"></mat-spinner>
                                            <span *ngIf="!isSubmitting">
                                                Submit Application
                                            </span>
                                            <span *ngIf="isSubmitting">
                                                Submitting Application...
                                            </span>
                                        </button>

                                        <p class="mt-3 text-sm text-center font-semibold" style="color: #04b2e1;">
                                            You'll be able to make payment after submitting your application
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons (Only shown before submission) -->
                        <div class="flex justify-between mt-6 gap-3" *ngIf="!applicationSubmitted">
                            <button
                                mat-stroked-button
                                (click)="stepper.previous()"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg">
                                <mat-icon class="mr-1">arrow_back</mat-icon>
                                Back
                            </button>
                        </div>

                    </form>
                </mat-step>
            </mat-horizontal-stepper>
        </div>
    </div>
</div>

<!-- Share Quote Dialog Template (MatDialog) -->
<ng-template #shareDialog>
    <div class="w-full max-w-md p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Share Quote Details</h2>
                <p class="text-sm text-gray-500">Choose how you'd like to share the quote information.</p>
            </div>
            <button type="button" mat-icon-button (click)="closeShareDialog()">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button type="button" class="border rounded-xl p-4 flex flex-col items-center justify-center hover:bg-gray-50 whatsapp-option" (click)="shareViaWhatsApp(); closeShareDialog()">
                <span class="icon-circle mb-2">WA</span>
                <span class="text-sm font-medium text-gray-800">WhatsApp</span>
            </button>

            <button type="button" class="border rounded-xl p-4 flex flex-col items-center justify-center hover:bg-gray-50" (click)="shareViaGmail(); closeShareDialog()">
                <mat-icon class="text-red-500 mb-2">mail</mat-icon>
                <span class="text-sm font-medium text-gray-800">Gmail</span>
            </button>

            <button type="button" class="border rounded-xl p-4 flex flex-col items-center justify-center hover:bg-gray-50" (click)="shareViaOutlook(); closeShareDialog()">
                <mat-icon class="text-blue-600 mb-2">mail</mat-icon>
                <span class="text-sm font-medium text-gray-800">Outlook</span>
            </button>

            <button type="button" class="border rounded-xl p-4 flex flex-col items-center justify-center hover:bg-gray-50" (click)="shareViaOutlook(); closeShareDialog()">
                <mat-icon class="text-blue-400 mb-2">mail</mat-icon>
                <span class="text-sm font-medium text-gray-800">Other Email</span>
            </button>
        </div>
    </div>
</ng-template>
