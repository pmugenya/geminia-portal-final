<div class="flex w-full flex-col items-center p-6 md:p-8">
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-[60vh] w-full">
        <mat-spinner diameter="60" color="primary"></mat-spinner>
        <p class="mt-4 text-gray-600 font-medium">Loading quote details...</p>
    </div>
    <div class="w-full max-w-screen-xl" *ngIf="!isLoading && quote">

        <fuse-alert
            name="quoteDownloadError"
            type="error"
            [dismissible]="true"
            [appearance]="'soft'">
            Failed to download quote. Please try again later.
        </fuse-alert>


        <!-- Header -->
        <div class="flex items-center justify-between border-b pb-4 mb-6">
            <div>
                <h2 class="text-2xl font-semibold leading-8 tracking-tight">
                    <h2 class="text-2xl font-bold text-gray-900">Marine Quote Details - {{quote?.refno}}</h2>
                </h2>
                <div class="text-secondary text-sm font-medium tracking-tight">
                    <p class="text-sm text-gray-600 mt-1">
                        Reference:
                        <span class="reference-pill">{{quote?.refno}}</span>
                    </p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button mat-flat-button color="primary" class="buy-btn" (click)="buyNow()" *ngIf="quote?.status==='DRAFT'">
                    <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:credit-card'"></mat-icon>
                    Buy Now
                </button>
                <button mat-flat-button color="primary" class="buy-btn" (click)="payNow()" *ngIf="quote?.status==='PENDING'">
                    <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:credit-card'"></mat-icon>
                    Pay Now
                </button>
                <button
                    mat-flat-button
                    color="primary"
                    class="download-btn"
                    (click)="downloadQuote()">
                    <mat-icon svgIcon="heroicons_outline:arrow-down-tray" class="mr-2"></mat-icon>
                    Download Quote
                </button>
                <button
                    type="button"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-sm font-medium bg-white text-gray-700 hover:bg-gray-50 share-trigger-btn"
                    (click)="openShareModal()">
                    <mat-icon class="icon-size-4">share</mat-icon>
                    <span>Share Quote</span>
                </button>
                <button
                    type="button"
                    (click)="goToDashboard()"
                    class="inline-flex items-center gap-2 px-4 py-1 rounded-full border text-sm font-medium bg-white header-close-btn">
                    <span class="text-base font-normal" aria-hidden="true">&times;</span>
                    <span>Close</span>
                </button>
            </div>
        </div>

        <!-- M-PESA Payment Section -->
        <div *ngIf="showPayment" class="w-full max-w-xl mx-auto mb-6"> <!-- constrain width -->
            <div class="p-6 bg-white rounded-xl border-2 border-blue-300 shadow-sm">
                <h3 class="font-bold text-gray-900 mb-4 flex items-center">
                    <mat-icon class="text-blue-600 mr-2">payment</mat-icon>
                    M-PESA Payment Instructions
                </h3>

                <div class="space-y-3">
                    <!-- Paybill and Account -->
                    <div class="flex justify-between p-2 bg-gray-50 rounded">
                        <span class="text-gray-700">Paybill Number:</span>
                        <span class="font-bold text-gray-900">553201</span>
                    </div>

                    <div class="flex justify-between p-2 bg-gray-50 rounded">
                        <span class="text-gray-700">Account Number:</span>
                        <span class="font-bold text-gray-900">{{ quote?.refno }}</span>
                    </div>

                    <!-- M-PESA Number Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Enter M-PESA Number *
                        </label>
                        <input
                            class="w-full px-3 py-2 border rounded-md focus:ring-2"
                            [ngClass]="!paymentForm.get('mpesaNumber')?.value ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-blue-500'"
                            formControlName="mpesaNumber"
                            placeholder="07XX XXX XXX"
                            maxlength="10"
                            (input)="onMpesaNumberInput($event)">
                        <p class="text-xs text-gray-500 mt-1">
                            Enter the M-PESA number to receive the payment prompt
                        </p>
                    </div>
                </div>

                <!-- Payment Button -->
                <div class="mt-4 flex flex-col space-y-3">
                <button
                    mat-raised-button
                    color="primary"
                    class="w-full mt-4 py-3 text-lg font-semibold flex items-center justify-center"
                    [disabled]="paymentProcessing || !paymentForm.get('mpesaNumber')?.value"
                    (click)="initiatePayment()">
                    <mat-spinner *ngIf="paymentProcessing" diameter="24" class="mr-2"></mat-spinner>
                    <mat-icon *ngIf="!paymentProcessing" class="mr-2">send</mat-icon>
                    {{ paymentProcessing ? 'Processing Payment...' : 'Send Payment Prompt' }}
                </button>
                <button
                    mat-stroked-button
                    color="warn"
                    class="w-full py-3 text-lg font-semibold"
                    [disabled]="paymentProcessing"
                    (click)="showPayment = false">
                    <mat-icon class="mr-2">close</mat-icon>
                    Cancel
                </button>
                </div>

                <p class="text-xs text-center text-gray-500 mt-2">
                    You will receive an M-PESA prompt on your phone. Enter your PIN to complete the payment.
                </p>
            </div>
        </div>




        <!-- Basic Info Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-card rounded-xl shadow p-5">
                <h3 class="text-sm font-medium text-secondary mb-2">Customer</h3>
                <div class="text-lg font-semibold">{{ quote?.firstName }} {{ quote?.lastName }}</div>
                <div class="text-sm text-secondary">{{ quote?.email }}</div>
                <div class="text-sm text-secondary">{{ quote?.phoneNo }}</div>
            </div>

            <div class="bg-card rounded-xl shadow p-5">
                <h3 class="text-sm font-medium text-secondary mb-2">Category & Product</h3>
                <div class="text-lg font-semibold">{{ quote?.category }}</div>
                <div class="text-sm text-secondary">{{ quote?.prodName }}</div>
            </div>

            <div class="bg-card rounded-xl shadow p-5">
                <h3 class="text-sm font-medium text-secondary mb-2">Status</h3>
                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium"
                      [ngClass]="getStatusColor(quote?.status)">
          {{ quote?.status }}
        </span>
                <div class="text-sm text-secondary mt-2">
                    Expires on: <span class="font-medium">{{ quote?.expiryDate | date }}</span>
                </div>
            </div>
        </div>

        <!-- Shipping & Cargo Details -->
        <div class="bg-card rounded-xl shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4">Shipping & Cargo Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="text-sm text-secondary">Cargo Type</label>
                    <div class="font-medium">{{ quote?.cargotype }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Shipping Mode</label>
                    <div class="font-medium">{{ quote?.shippingmode }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Packaging Type</label>
                    <div class="font-medium">{{ quote?.packagingtype }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Origin Country</label>
                    <div class="font-medium">{{ quote?.originId }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Destination</label>
                    <div class="font-medium">{{ quote?.destination }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Vessel Name</label>
                    <div class="font-medium">{{ quote?.vesselName }}</div>
                </div>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="bg-card rounded-xl shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4">Premium Details</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div>
                    <label class="text-sm text-secondary">Sum Assured</label>
                    <div class="font-medium">{{ quote?.sumassured | currency:'KES ' }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Premium</label>
                    <div class="font-medium">{{ quote?.premium | currency:'KES ' }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">PHCF</label>
                    <div class="font-medium">{{ quote?.phcf | currency:'KES ' }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Training Levy</label>
                    <div class="font-medium">{{ quote?.traininglevy | currency:'KES ' }}</div>
                </div>
                <div>
                    <label class="text-sm text-secondary">Stamp Duty</label>
                    <div class="font-medium">{{ quote?.sd | currency:'KES ' }}</div>
                </div>
                <div>
                    <div class="flex items-center text-sm text-secondary">
                        <span>Net Premium</span>
                        <span class="net-premium-pill">{{ quote?.netprem | currency:'KES ' }}</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Description Section -->
        <div class="bg-card rounded-xl shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-3">Description</h3>
            <p class="text-secondary text-sm leading-relaxed">
                {{ quote?.description || 'No description provided for this quote.' }}
            </p>
        </div>

        <!-- Share Payment Details Modal -->
        <div *ngIf="showShareModal" class="share-modal-backdrop">
            <div class="share-modal">
                <div class="share-modal-header">
                    <h3>Share Quote Details</h3>
                    <button type="button" class="close-btn" (click)="closeShareModal()">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>
                <p class="share-modal-subtitle">Choose how you'd like to share the Quote information</p>

                <div class="share-options">
                    <button type="button" class="share-option whatsapp" (click)="shareViaWhatsApp()">
                        <span class="icon-circle whatsapp-icon">WA</span>
                        <span>WhatsApp</span>
                    </button>
                    <button type="button" class="share-option" (click)="shareViaGmail()">
                        <span class="icon-circle">
                            <mat-icon>mail</mat-icon>
                        </span>
                        <span>Gmail</span>
                    </button>
                    <button type="button" class="share-option" (click)="shareViaOutlook()">
                        <span class="icon-circle">
                            <mat-icon>mail</mat-icon>
                        </span>
                        <span>Outlook</span>
                    </button>
                    <button type="button" class="share-option">
                        <span class="icon-circle">
                            <mat-icon>mail</mat-icon>
                        </span>
                        <span>Other Email</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
