<div class="flex flex-col flex-auto w-full">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-8 sm:px-10 border-b bg-card dark:bg-transparent">
        <div class="flex-1 min-w-0">
            <div class="flex flex-wrap items-center font-medium">
                <div>
                    <a class="whitespace-nowrap text-primary-500 hover:underline cursor-pointer" (click)="router.navigate(['/dashboard'])">
                        Home
                    </a>
                </div>
                <div class="flex items-center ml-1 whitespace-nowrap">
                    <mat-icon class="icon-size-5 text-secondary" [svgIcon]="'heroicons_mini:chevron-right'"></mat-icon>
                    <span class="ml-1 text-secondary">Travel Insurance Quote</span>
                </div>
            </div>
            <div class="mt-2">
                <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Get Your Travel Insurance Quote
                </h2>
                <p class="mt-2 text-secondary">Comprehensive coverage for your journey abroad</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-auto p-6 sm:p-10">
        <div class="bg-card rounded-2xl shadow-lg">
            <mat-horizontal-stepper [linear]="true" #stepper class="w-full fuse-mat-stepper">
                <!-- Step 1: Available Plans -->
                <mat-step [stepControl]="quoteForm">
                    <ng-template matStepLabel>Trip Details & Plans</ng-template>
                    <div class="p-8">
                        <div class="mb-8">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Select Your Travel Plan</h2>
                            <p class="text-base text-secondary">Tell us about your trip to see available plans and pricing.</p>
                        </div>
                    <form [formGroup]="quoteForm" class="w-full">
                        <!-- Alert -->
                        <fuse-alert
                            *ngIf="submissionError"
                            class="mb-6"
                            [title]="'Submission Failed!'"
                            [type]="'error'"
                            [dismissible]="true"
                            (dismiss)="submissionError = null">
                            {{ submissionError }}
                        </fuse-alert>

                        <!-- Travel Information Section -->
                        <div class="mb-10">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <mat-icon class="icon-size-5 mr-2 text-primary-600">flight_takeoff</mat-icon>
                                Travel Information
                            </h3>
                            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">

                                <!-- Travelling From -->
                                <mat-form-field appearance="fill" class="w-full fuse-mat-no-subscript">
                                    <mat-label>Travelling From <span class="text-warn">*</span></mat-label>

                                    <mat-select formControlName="countryFromId" panelClass="country-search-panel">
                                        <!-- Search input -->
                                        <mat-option disabled class="search-option">
                                            <input
                                                matInput
                                                (click)="$event.stopPropagation()"
                                                (keydown)="$event.stopPropagation()"
                                                placeholder="Search countries..."
                                                class="w-full px-3 py-2 outline-none"
                                                [formControl]="searchCtrl"
                                            >
                                        </mat-option>
                                        <mat-option *ngFor="let c of filteredCountries$ | async" [value]="c.id">
                                            {{ c.countryname }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-icon matPrefix class="text-hint">public</mat-icon>
                                    <mat-error>Please select your departure country</mat-error>
                                </mat-form-field>

                                <!-- Travelling To -->
                                <mat-form-field appearance="fill" class="w-full fuse-mat-no-subscript">
                                    <mat-label>Travelling To <span class="text-warn">*</span></mat-label>

                                    <mat-select formControlName="countryToId" panelClass="country-search-panel">
                                        <mat-option disabled class="search-option">
                                            <input
                                                matInput
                                                (click)="$event.stopPropagation()"
                                                (keydown)="$event.stopPropagation()"
                                                placeholder="Search countries..."
                                                class="w-full px-3 py-2 outline-none"
                                                [formControl]="searchDestCtrl"
                                            >
                                        </mat-option>
                                        <mat-option *ngFor="let c of filteredDestCountries$ | async" [value]="c.id">
                                            {{ c.countryname }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-icon matPrefix class="text-hint">flight_land</mat-icon>
                                    <mat-error>Please select your destination country</mat-error>
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Travel Dates Section -->
                        <div class="mb-10">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <mat-icon class="icon-size-5 mr-2 text-primary-600">date_range</mat-icon>
                                Travel Dates
                            </h3>
                            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                <mat-form-field appearance="fill" class="w-full">
                                    <mat-label>Departure Date <span class="text-warn">*</span></mat-label>
                                    <input matInput [matDatepicker]="dispatchPicker" formControlName="dateOfTravel" [min]="today" readonly>
                                    <mat-datepicker-toggle matSuffix [for]="dispatchPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #dispatchPicker></mat-datepicker>
                                    <mat-icon matPrefix class="text-hint">event</mat-icon>
                                    <mat-error>Departure date is required</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="fill" class="w-full">
                                    <mat-label>Return Date <span class="text-warn">*</span></mat-label>
                                    <input matInput [matDatepicker]="arrivalPicker" formControlName="estimatedArrival" [min]="quoteForm.get('dateOfTravel')?.value || today" readonly>
                                    <mat-datepicker-toggle matSuffix [for]="arrivalPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #arrivalPicker></mat-datepicker>
                                    <mat-icon matPrefix class="text-hint">event</mat-icon>
                                    <mat-error *ngIf="quoteForm.get('estimatedArrival')?.hasError('beforeDispatch')">
                                        Return date must be after departure date
                                    </mat-error>
                                    <mat-error *ngIf="!quoteForm.get('estimatedArrival')?.hasError('beforeDispatch')">
                                        Return date is required
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <!-- Trip Duration Display -->
                            <div *ngIf="totalDays > 0" class="mt-4 p-4 bg-primary-50 dark:bg-primary-900/10 rounded-lg border border-primary-100 dark:border-primary-900/20">
                                <div class="flex items-center">
                                    <mat-icon class="text-primary-600 mr-3">schedule</mat-icon>
                                    <div>
                                        <span class="text-sm text-secondary">Total Trip Duration</span>
                                        <p class="text-2xl font-bold text-primary-600">{{ totalDays }} day{{ totalDays > 1 ? 's' : '' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Insurance Plans Section -->
                        <div *ngIf="totalDays > 1" class="mb-10">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <mat-icon class="icon-size-5 mr-2 text-primary-600">shield</mat-icon>
                                Choose Your Coverage Plan
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div
                                    *ngFor="let plan of rates"
                                    class="plan-card group relative flex flex-col rounded-xl border-2 bg-card shadow-md hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden"
                                    [ngClass]="{
                                        'border-primary-500 bg-primary-50/30 dark:bg-primary-900/10': quoteForm.get('plan')?.value === plan.id,
                                        'border-gray-200 hover:border-primary-300': quoteForm.get('plan')?.value !== plan.id
                                    }"
                                    (click)="quoteForm.get('plan')?.setValue(plan.id)"
                                >
                                    <!-- Selected Badge -->
                                    <div *ngIf="quoteForm.get('plan')?.value === plan.id"
                                         class="absolute top-4 right-4 z-10 bg-primary-600 text-white px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1">
                                        <mat-icon class="icon-size-4">check_circle</mat-icon>
                                        Selected
                                    </div>

                                    <!-- Price Section -->
                                    <div class="p-6 pb-4 bg-gradient-to-br from-primary-500/5 to-transparent">
                                        <div class="flex items-baseline gap-2 mb-3">
                                            <span class="text-4xl font-bold text-primary-600">
                                                {{ (plan.rateAmount * plan.exchangeRate) | number:'1.0-0' }}
                                            </span>
                                            <span class="text-lg font-semibold text-gray-600">KES</span>
                                        </div>
                                        <p class="text-sm text-secondary">per person</p>

                                        <!-- Tags -->
                                        <div class="flex flex-wrap gap-2 mt-4">
                                            <span
                                                *ngFor="let tag of plan.planTagsData"
                                                class="text-xs font-medium bg-primary-100 dark:bg-primary-900/20 text-primary-700 dark:text-primary-400 px-3 py-1 rounded-full"
                                            >
                                                {{ tag.tag }}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Benefits -->
                                    <ul class="px-6 py-4 flex-1 space-y-3">
                                        <li
                                            *ngFor="let benefit of plan.benefitsData"
                                            class="flex items-start gap-3"
                                        >
                                            <mat-icon class="icon-size-5 text-green-500 flex-shrink-0 mt-0.5">check_circle</mat-icon>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-sm">{{ benefit.benefitName }}</div>
                                                <div class="text-xs text-secondary mt-0.5">
                                                    <span *ngIf="benefit.benefitLimit">{{ benefit.benefitLimit +' '+ benefit.currency }}</span>
                                                    <span *ngIf="benefit.notes"> - {{ benefit.notes }}</span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                    <!-- Select Button -->
                                    <div class="p-6 pt-4">
                                        <button
                                            type="button"
                                            mat-flat-button
                                            color="primary"
                                            class="w-full"
                                            [class.mat-accent]="quoteForm.get('plan')?.value === plan.id"
                                        >
                                            <mat-icon *ngIf="quoteForm.get('plan')?.value === plan.id">check</mat-icon>
                                            {{ quoteForm.get('plan')?.value === plan.id ? 'Selected' : 'Select Plan' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between items-center mt-8 pt-6 border-t">
                            <button
                                mat-button
                                color="accent"
                                type="button"
                                (click)="router.navigate(['/dashboard'])"
                                class="text-lg">
                                <mat-icon class="icon-size-5 mr-1">arrow_back</mat-icon>
                                Cancel
                            </button>
                            <button
                                mat-flat-button
                                color="primary"
                                type="button"
                                [disabled]="!quoteForm.valid"
                                (click)="moveToNext()"
                                class="text-lg px-8">
                                Continue
                                <mat-icon class="icon-size-5 ml-1">arrow_forward</mat-icon>
                            </button>
                        </div>
                    </form>
                    </div>
                </mat-step>

                <!-- Step 2: Traveler Details -->
                <mat-step [stepControl]="travelerDetailsForm">
                    <ng-template matStepLabel>Traveler Information</ng-template>
                    <div class="p-8">
                        <div class="mb-8">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Traveler Details</h2>
                            <p class="text-base text-secondary">Provide contact information and details for all travelers</p>
                        </div>

                    <form [formGroup]="travelerDetailsForm" *ngIf="!isLoadingData">

                        <fuse-alert
                            *ngIf="submissionError"
                            class="mb-6"
                            [title]="'Submission Failed!'"
                            [type]="'error'"
                            [dismissible]="true"
                            (dismiss)="submissionError = null">
                            {{ submissionError }}
                        </fuse-alert>
                        <div class="mb-10">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <mat-icon class="icon-size-5 mr-2 text-primary-600">contact_phone</mat-icon>
                                Primary Contact Information
                            </h3>
                        <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                                <mat-form-field appearance="fill" class="w-full">
                                    <mat-label>Email Address <span class="text-warn">*</span></mat-label>
                                    <input matInput type="email" formControlName="email"
                                           (input)="handleInputChange($event, 'email')"
                                           (blur)="trimInput($event, 'email')"
                                           (keydown)="preventLeadingSpace($event)"
                                           placeholder="your@email.com" />
                                    <mat-icon matPrefix class="text-hint">email</mat-icon>
                                    <mat-error *ngIf="tdf.email.hasError('required')">Email is required</mat-error>
                                    <mat-error *ngIf="tdf.email.hasError('email')">Please enter a valid email</mat-error>
                                    <mat-error *ngIf="tdf.email.hasError('whitespace')">Email cannot be empty</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="fill" class="w-full">
                                    <mat-label>Phone Number <span class="text-warn">*</span></mat-label>
                                    <input matInput type="tel" formControlName="phoneNumber"
                                           (input)="handleInputChange($event, 'phoneNumber')"
                                           (blur)="trimInput($event, 'phoneNumber')"
                                           (keydown)="preventLeadingSpace($event)"
                                           placeholder="+254712345678" />
                                    <mat-icon matPrefix class="text-hint">phone</mat-icon>
                                    <mat-error *ngIf="tdf.phoneNumber.hasError('required')">Phone number is required</mat-error>
                                    <mat-error *ngIf="tdf.phoneNumber.hasError('invalidPhoneNumber')">Please enter a valid phone number</mat-error>
                                    <mat-error *ngIf="tdf.phoneNumber.hasError('whitespace')">Phone cannot be empty</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="fill" class="w-full">
                                    <mat-label>Number of Travelers <span class="text-warn">*</span></mat-label>
                                    <input matInput type="number" formControlName="numTravelers" min="1" placeholder="1" />
                                    <mat-icon matPrefix class="text-hint">people</mat-icon>
                                    <mat-error *ngIf="tdf.numTravelers.hasError('required')">Number of travelers is required</mat-error>
                                    <mat-error *ngIf="tdf.numTravelers.hasError('min')">At least one traveler required</mat-error>
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Traveler Information Section -->
                        <div class="mb-10" formArrayName="travelers">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <mat-icon class="icon-size-5 mr-2 text-primary-600">badge</mat-icon>
                                Traveler Information
                            </h3>

                            <!-- Duplicate Traveler Error Message -->
                            <fuse-alert
                                *ngIf="travelers.hasError('duplicateTraveler') && travelers.touched"
                                class="mb-6"
                                [type]="'error'"
                                [dismissible]="false">
                                Each traveler must have a unique combination of full name and date of birth.
                            </fuse-alert>

                            <div *ngFor="let travelerGroup of travelers.controls; let i = index" [formGroupName]="i"
                                 class="mb-6 rounded-xl border-2 border-gray-200 bg-card shadow-sm p-6 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between mb-4 pb-3 border-b">
                                    <div class="flex items-center justify-between mb-4 pb-3 border-b">
                                        <h4 class="text-base font-semibold flex items-center gap-2">
                                            <mat-icon class="icon-size-5 text-primary-600">person</mat-icon>
                                            {{ i === 0 ? 'Primary Traveler' : 'Traveler ' + (i + 1) }}
                                        </h4>
                                    </div>

                                    <div *ngIf="i === 0 && clientQuoting" class="mb-4 flex items-center gap-3">
                                        <mat-checkbox color="primary"
                                                      formControlName="sameAsPrimary"
                                                      (change)="onSameAsPrimaryChange()">
                                            Same as Primary Contact
                                        </mat-checkbox>
                                    </div>
                                    <h4 class="text-base font-semibold flex items-center gap-2">
                                        <mat-icon class="icon-size-5 text-primary-600">person</mat-icon>
                                        {{ i === 0 ? 'Primary Traveler' : 'Traveler ' + (i + 1) }}
                                    </h4>
                                    <div *ngIf="travelerGroup.get('dob')?.valid && getAge(travelerGroup.get('dob')?.value) < 18"
                                         class="px-3 py-1 bg-blue-50 dark:bg-blue-900/10 text-blue-700 dark:text-blue-400 rounded-full text-xs font-semibold">
                                        Minor
                                    </div>
                                    <div *ngIf="travelerGroup.get('dob')?.valid && getAge(travelerGroup.get('dob')?.value) > 66"
                                         class="px-3 py-1 bg-blue-50 dark:bg-blue-900/10 text-blue-700 dark:text-blue-400 rounded-full text-xs font-semibold">
                                        Older Citizens
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <mat-form-field appearance="fill" class="w-full">
                                        <mat-label>Full Name <span class="text-warn">*</span></mat-label>
                                        <input matInput type="text" formControlName="fullName"
                                               (blur)="trimTravelerInput($event, i, 'fullName')"
                                               placeholder="John Doe" />
                                        <mat-icon matPrefix class="text-hint">badge</mat-icon>
                                        <mat-error *ngIf="travelerGroup.get('fullName')?.hasError('required')">Full name is required</mat-error>
                                        <mat-error *ngIf="travelerGroup.get('fullName')?.hasError('invalidName')">Enter at least two names</mat-error>
                                        <mat-error *ngIf="travelerGroup.get('fullName')?.hasError('whitespace')">Name cannot be empty</mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="fill" class="w-full">
                                        <mat-label>Date of Birth <span class="text-warn">*</span></mat-label>
                                        <input matInput [matDatepicker]="picker" formControlName="dob" placeholder="Select date" />
                                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                        <mat-datepicker #picker></mat-datepicker>
                                        <mat-icon matPrefix class="text-hint">cake</mat-icon>
                                        <mat-error *ngIf="travelerGroup.get('dob')?.hasError('required')">Date of birth is required</mat-error>
                                        <mat-error *ngIf="travelerGroup.get('dob')?.hasError('futureDate')">Date cannot be in the future</mat-error>
                                        <mat-error *ngIf="travelerGroup.get('dob')?.hasError('tooOld')">Please enter a valid year</mat-error>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Options -->
                        <div class="mb-10 p-6 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50/50 dark:bg-gray-900/10">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <mat-icon class="icon-size-5 mr-2 text-primary-600">add_circle</mat-icon>
                                Optional Coverage
                            </h3>
                            <mat-checkbox formControlName="winterSports" color="primary" class="text-base">
                                <span class="font-medium">Add Winter Sports Cover</span>
                                <span class="text-sm text-secondary ml-2">(Additional surcharge applies)</span>
                            </mat-checkbox>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between items-center pt-6 border-t">
                            <button
                                mat-button
                                type="button"
                                matStepperPrevious
                                class="text-lg">
                                <mat-icon class="icon-size-5 mr-1">arrow_back</mat-icon>
                                Back
                            </button>
                            <button
                                mat-flat-button
                                color="primary"
                                type="button"
                                [disabled]="!travelerDetailsForm.valid"
                                (click)="saveTravelQuote()"
                                class="text-lg px-8">
                                Continue to Review
                                <mat-icon class="icon-size-5 ml-1">arrow_forward</mat-icon>
                            </button>
                        </div>
                    </form>
                    </div>
                </mat-step>

                <!-- Step 3: Review & Buy Quote -->
                <mat-step>
                    <ng-template matStepLabel>Review & Confirm</ng-template>
                    <div class="p-8">
                        <div class="mb-8">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Review Your Quote</h2>
                            <p class="text-base text-secondary">Please review your travel insurance details before proceeding to payment</p>
                        </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                        <!-- LEFT SIDE: Quote Details -->
                        <div class="lg:col-span-2 space-y-6" *ngIf="quoteDetails">

                            <!-- Trip Details -->
                            <div class="p-6 bg-card rounded-xl shadow-md border-2 border-gray-100">
                                <h4 class="text-lg font-semibold mb-4 flex items-center">
                                    <mat-icon class="icon-size-5 mr-2 text-primary-600">flight_takeoff</mat-icon>
                                    Trip Details
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Plan</span>
                                        <span class="text-base font-semibold">{{ quoteDetails.planName }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Cover Period</span>
                                        <span class="text-base font-semibold">{{ this.totalDays }} Day{{ this.totalDays > 1 ? 's' : '' }}</span>
                                        <span class="text-xs text-secondary">{{ quoteDetails.fromDate | date:'mediumDate' }} - {{ quoteDetails.toDate | date:'mediumDate' }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Travelling From</span>
                                        <span class="text-base font-semibold">{{ quoteDetails.countryFrom }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Travelling To</span>
                                        <span class="text-base font-semibold">{{ quoteDetails.countryTo }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Number of Travellers</span>
                                        <span class="text-base font-semibold">{{ quoteDetails.travellersCnt }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div class="p-6 bg-card rounded-xl shadow-md border-2 border-gray-100">
                                <h4 class="text-lg font-semibold mb-4 flex items-center">
                                    <mat-icon class="icon-size-5 mr-2 text-primary-600">contact_phone</mat-icon>
                                    Contact Information
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Email</span>
                                        <span class="text-base font-semibold break-all">{{ quoteDetails.email }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-medium text-secondary uppercase tracking-wide mb-1">Phone</span>
                                        <span class="text-base font-semibold">{{ quoteDetails.mobile }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Travelers -->
                            <div class="p-6 bg-card rounded-xl shadow-md border-2 border-gray-100">
                                <h4 class="text-lg font-semibold mb-4 flex items-center">
                                    <mat-icon class="icon-size-5 mr-2 text-primary-600">people</mat-icon>
                                    Insured Travelers
                                </h4>
                                <ul class="space-y-3">
                                    <li *ngFor="let traveler of quoteDetails.travellers; let i = index"
                                        class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-900/10 rounded-lg">
                                        <div class="flex-shrink-0 w-8 h-8 bg-primary-100 dark:bg-primary-900/20 text-primary-600 rounded-full flex items-center justify-center font-semibold text-sm">
                                            {{ i + 1 }}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold">{{ traveler.travellerName }}</div>
                                            <div class="text-sm text-secondary">DOB: {{ traveler.dob | date:'longDate' }}</div>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Benefits -->
                            <div class="p-6 bg-card rounded-xl shadow-md border-2 border-gray-100">
                                <h4 class="text-lg font-semibold mb-4 flex items-center">
                                    <mat-icon class="icon-size-5 mr-2 text-primary-600">shield</mat-icon>
                                    Coverage Benefits
                                </h4>
                                <div class="overflow-hidden rounded-lg border border-gray-200">
                                    <table *ngIf="quoteDetails.travelBenefits" class="min-w-full">
                                        <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900/10 border-b">
                                            <th class="p-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Benefit</th>
                                            <th class="p-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Coverage Limit</th>
                                            <th class="p-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Notes</th>
                                        </tr>
                                        </thead>
                                        <tbody class="bg-card divide-y divide-gray-200">
                                        <tr *ngFor="let benefit of quoteDetails.travelBenefits" class="hover:bg-gray-50 dark:hover:bg-gray-900/5 transition-colors">
                                            <td class="p-3 text-sm font-medium">{{ benefit.benefitName }}</td>
                                            <td class="p-3 text-sm text-secondary">{{ benefit.benefitLimit }}</td>
                                            <td class="p-3 text-sm text-secondary">{{ benefit.notes || '-' }}</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                        <!-- RIGHT SIDE: Premium Summary -->
                        <div class="lg:sticky lg:top-24" *ngIf="quoteDetails">
                            <div class="bg-gradient-to-br from-primary-50 to-accent-50 dark:from-primary-900/10 dark:to-accent-900/10 p-6 rounded-2xl shadow-xl border-2 border-primary-100 dark:border-primary-900/20">
                                <div class="flex items-center gap-2 mb-6">
                                    <mat-icon class="text-primary-600">receipt_long</mat-icon>
                                    <h3 class="text-xl font-bold">Premium Summary</h3>
                                </div>

                                <div class="space-y-4 mb-6">
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-secondary">Base Premium</span>
                                        <span class="font-semibold text-lg">KES {{ quoteDetails.premium | number:'1.2-2' }}</span>
                                    </div>

                                    <div *ngIf="quoteDetails.winterPrem > 0" class="flex justify-between items-center py-2 text-accent-600">
                                        <span class="flex items-center gap-1">
                                            <mat-icon class="icon-size-4">ac_unit</mat-icon>
                                            Winter Sports
                                        </span>
                                        <span class="font-semibold">+ KES {{ quoteDetails.winterPrem | number:'1.2-2' }}</span>
                                    </div>
                                    <div *ngIf="quoteDetails.surcharge > 0" class="flex justify-between items-center py-2 text-accent-600">
                                        <span class="flex items-center gap-1">
                                            <mat-icon class="icon-size-4">price_change</mat-icon>
                                            Surcharge Premium
                                        </span>
                                        <span class="font-semibold">+ KES {{ quoteDetails.surcharge | number:'1.2-2' }}</span>
                                    </div>
                                    <div *ngIf="quoteDetails.discount > 0" class="flex justify-between items-center py-2 text-accent-600">
                                        <span class="flex items-center gap-1">
                                            <mat-icon class="icon-size-4">sell</mat-icon>
                                            Discount Premium
                                        </span>
                                        <span class="font-semibold">- KES ({{ quoteDetails.discount | number:'1.2-2' }})</span>
                                    </div>

                                    <div class="border-t border-gray-300 dark:border-gray-700 my-3"></div>

                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between items-center">
                                            <span class="text-secondary">PHCF (0.25%)</span>
                                            <span class="font-medium">KES {{ quoteDetails.phcf | number:'1.2-2' }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-secondary">Training Levy (0.2%)</span>
                                            <span class="font-medium">KES {{ quoteDetails.tl | number:'1.2-2' }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-secondary">Stamp Duty</span>
                                            <span class="font-medium">KES {{ quoteDetails.sd | number:'1.2-2' }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-5 bg-card dark:bg-gray-900 rounded-xl border-2 border-primary-200 dark:border-primary-900/30 mb-6">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="text-sm text-secondary mb-1">Total Amount</div>
                                            <div class="text-3xl font-bold text-primary-600">KES {{ quoteDetails.netPrem | number:'1.2-2' }}</div>
                                        </div>
                                        <mat-icon class="icon-size-12 text-primary-200 dark:text-primary-900/30">payments</mat-icon>
                                    </div>
                                </div>

                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="buyNow()"
                                    class="w-full text-lg py-6 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all">
                                    <mat-icon class="mr-2">shopping_cart</mat-icon>
                                    Proceed to Payment
                                </button>

                                <div class="mt-4 flex items-center justify-center gap-2 text-xs text-secondary">
                                    <mat-icon class="icon-size-4">lock</mat-icon>
                                    <span>Secure payment processing</span>
                                </div>
                            </div>
                        </div>


                    </div>
                    </div>
                </mat-step>

                <!-- Step 4: Payment & Passport Details -->
                <mat-step>
                    <ng-template matStepLabel>Payment & Documents</ng-template>
                    <form [formGroup]="paymentForm" class="w-full">
                        <fuse-alert
                            *ngIf="submissionError"
                            class="mb-6"
                            [title]="'Submission Failed!'"
                            [type]="'error'"
                            [dismissible]="true"
                            (dismiss)="submissionError = null">
                            {{ submissionError }}
                        </fuse-alert>
                    <div class="p-8">
                        <div class="mb-8">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Complete Your Application</h2>
                            <p class="text-base text-secondary">Provide passport details and proceed with payment</p>
                        </div>

                        <div class="mb-4 p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;"  [class.readonly-section]="applicationSubmitted">
                            <h2 class="text-sm font-semibold text-gray-900 mb-3">Document Uploads</h2>

                            <!-- Conditional Documents (KRA & National ID) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3" *ngIf="userDocs">
                                <!-- KRA PIN Certificate -->
                                <div *ngIf="!userDocs.kraDocumentExists">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        KRA PIN Certificate <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                         [ngClass]="duplicateFileErrors['kraPinCertificate'] ? 'border-red-500 bg-red-50' : (!paymentForm.get('kraPinCertificate')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400')"
                                         (click)="kraPinCertificate.click()">
                                        <button type="button" mat-button color="primary">Choose file</button>
                                        <input hidden #kraPinCertificate type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'kraPinCertificate')">
                                        <p class="text-xs text-gray-500 mt-1">{{ paymentForm.get('kraPinCertificate').value?.name || 'No file chosen' }}</p>
                                    </div>
                                    <p *ngIf="duplicateFileErrors['kraPinCertificate']" class="mt-1 text-xs text-red-600 text-left">
                                        {{ duplicateFileErrors['kraPinCertificate'] }}
                                    </p>
                                </div>

                                <!-- National ID -->
                                <div *ngIf="!userDocs.idfDocumentExists">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        National ID <span class="text-red-500">*</span>
                                    </label>
                                    <div class="border-2 border-dashed rounded-md p-3 text-center cursor-pointer transition-colors"
                                         [ngClass]="duplicateFileErrors['nationalId'] ? 'border-red-500 bg-red-50' : (!paymentForm.get('nationalId')?.value ? 'border-red-500' : 'border-gray-300 hover:border-blue-400')"
                                         (click)="nationalId.click()">
                                        <button type="button" mat-button color="primary">Choose file</button>
                                        <input hidden #nationalId type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelected($event, 'nationalId')">
                                        <p class="text-xs text-gray-500 mt-1">{{ paymentForm.get('nationalId').value?.name || 'No file chosen' }}</p>
                                    </div>
                                    <p *ngIf="duplicateFileErrors['nationalId']" class="mt-1 text-xs text-red-600 text-left">
                                        {{ duplicateFileErrors['nationalId'] }}
                                    </p>
                                </div>
                            </div>

                            <!-- Terms Checkbox -->
                            <div class="mt-3"
                                 [ngClass]="paymentForm.get('agreeToTerms')?.invalid && paymentForm.get('agreeToTerms')?.touched ? 'border border-red-500 bg-red-50 rounded-md p-3' : ''">
                                <div class="flex items-start">
                                    <mat-checkbox formControlName="agreeToTerms" color="primary"></mat-checkbox>
                                    <label class="text-sm text-gray-600 ml-2">
                                        I agree to the
                                        <a (click)="openTermsOfUse($event)" class="hover:underline cursor-pointer" style="color: #04b2e1;">Terms of Use</a>
                                        and
                                        <a (click)="openPrivacyPolicy($event)" class="hover:underline cursor-pointer" style="color: #04b2e1;">Privacy Policy</a>
                                    </label>
                                </div>
                                <p
                                    *ngIf="paymentForm.get('agreeToTerms')?.invalid && paymentForm.get('agreeToTerms')?.touched"
                                    class="text-xs text-red-600 mt-1">
                                    You must agree to the Terms of Use and Privacy Policy to continue.
                                </p>
                            </div>
                        </div>
                        <div class="mb-4 p-4 border-2 rounded-lg bg-white" style="border-color: #04b2e1;"  [class.readonly-section]="applicationSubmitted">

                            <h2 class="text-sm font-semibold text-gray-900 mb-3">Personal Information</h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ID Number *</label>
                                    <input class="w-full px-3 py-2 border rounded-md special-focus-field"
                                           [ngClass]="!paymentForm.get('idNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="idNumber"
                                           placeholder="Enter ID number"
                                           maxlength="10">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">KRA PIN *</label>
                                    <input class="w-full px-3 py-2 border rounded-md uppercase special-focus-field"
                                           [ngClass]="!paymentForm.get('kraPin')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="kraPin"
                                           placeholder="Enter KRA PIN"
                                           maxlength="11">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                           formControlName="firstName" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                           formControlName="lastName" readonly>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                                    <input class="w-full px-3 py-2 border rounded-md"
                                           [ngClass]="!paymentForm.get('emailAddress')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="emailAddress"
                                           type="email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                    <input class="w-full px-3 py-2 border rounded-md bg-gray-100"
                                           [ngClass]="!paymentForm.get('phoneNumber')?.value ? 'border-red-500' : 'border-gray-300'"
                                           formControlName="phoneNumber"
                                           maxlength="10"
                                           readonly>
                                </div>
                            </div>
                        </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                        <!-- LEFT SIDE: Passenger Passport Details -->
                        <div class="lg:col-span-2 space-y-6"  [class.readonly-section]="applicationSubmitted">
                            <div class="p-6 bg-card rounded-xl shadow-md border-2 border-gray-100">
                                <h4 class="text-lg font-semibold mb-4 flex items-center">
                                    <mat-icon class="icon-size-5 mr-2 text-primary-600">assignment_ind</mat-icon>
                                    Passport Information
                                </h4>

                                <div class="overflow-hidden rounded-lg border border-gray-200">
                                    <table class="min-w-full">
                                        <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900/10 border-b">
                                            <th class="p-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Traveler</th>
                                            <th class="p-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Passport Number</th>
                                            <th class="p-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Document</th>
                                        </tr>
                                        </thead>
                                        <tbody class="bg-card divide-y divide-gray-200" *ngIf="quoteDetails">
                                        <tr *ngFor="let traveler of quoteDetails.travellers; let i = index" class="hover:bg-gray-50 dark:hover:bg-gray-900/5 transition-colors">
                                            <td class="p-3">
                                                <div class="font-semibold text-sm">{{ traveler.travellerName }}</div>
                                            </td>

                                            <!-- Editable Passport Number -->
                                            <td class="p-3">
                                                <mat-form-field appearance="outline" class="w-full fuse-mat-dense fuse-mat-no-subscript">
                                                    <input
                                                        matInput
                                                        type="text"
                                                        [formControl]="getPassportControl(i)"
                                                        placeholder="A12345678"
                                                        (blur)="check(getPassportControl(i).value, i)"
                                                    />

                                                    <mat-error *ngIf="getPassportControl(i).hasError('required')">
                                                        Passport number is required
                                                    </mat-error>
                                                </mat-form-field>
                                            </td>

                                            <!-- Upload Passport Document -->
                                            <td class="p-3">
                                                <div class="flex flex-col">

                                                    <div class="flex items-center gap-2" *ngIf="!traveler.dataFound">
                                                        <input
                                                            type="file"
                                                            (change)="onPassportUpload($event, i)"
                                                            class="hidden"
                                                            #fileInput
                                                            accept="image/*,.pdf"
                                                        />

                                                        <button
                                                            mat-stroked-button
                                                            color="primary"
                                                            (click)="fileInput.click()"
                                                            class="text-sm">
                                                            <mat-icon class="icon-size-4 mr-1">upload_file</mat-icon>
                                                            Upload
                                                        </button>

                                                        <span *ngIf="traveler.passportFileName"
                                                              class="text-xs text-secondary truncate max-w-[150px]">{{ traveler.passportFileName }}
      </span>
                                                    </div>

                                                    <!-- FILE REQUIRED ERROR -->
                                                    <mat-error *ngIf="isPassportFileMissing(i) && !traveler.dataFound" >
                                                        Passport document is required
                                                    </mat-error>

                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT SIDE: Payment Summary -->
                        <div class="lg:sticky lg:top-24" *ngIf="quoteDetails">
                            <div class="p-6 rounded-2xl shadow-xl"
                                 [ngClass]="applicationSubmitted
                                     ? 'bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/10 dark:to-emerald-900/10 border-2 border-green-200'
                                     : 'bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/10 dark:to-orange-900/10 border-2 border-amber-200'">

                            <!-- Success Message -->
                            <fuse-alert
                                *ngIf="applicationSubmitted"
                                class="mb-6"
                                [type]="'success'"
                                [dismissible]="false">
                                <div class="font-bold mb-1">Application Submitted!</div>
                                <div class="text-sm">Reference: <strong>{{ paymentRefNo }}</strong></div>
                            </fuse-alert>

                            <div class="flex items-center gap-2 mb-6">
                                <mat-icon [class]="applicationSubmitted ? 'text-green-600' : 'text-amber-600'">
                                    {{ applicationSubmitted ? 'payment' : 'receipt_long' }}
                                </mat-icon>
                                <h3 class="text-xl font-bold">
                                    {{ applicationSubmitted ? 'Payment Details' : 'Payment Summary' }}
                                </h3>
                            </div>


                            <!-- Breakdown -->
                            <div class="space-y-3 text-sm mb-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-secondary">Base Premium</span>
                                    <span class="font-semibold">KES {{ quoteDetails.premium | number:'1.2-2' }}</span>
                                </div>

                                <div *ngIf="quoteDetails.winterPrem > 0" class="flex justify-between items-center text-accent-600">
                                    <span>Winter Sports</span>
                                    <span class="font-semibold">+ KES {{ quoteDetails.winterPrem | number:'1.2-2' }}</span>
                                </div>
                                <div *ngIf="quoteDetails.surcharge > 0" class="flex justify-between items-center text-accent-600">
                                    <span>Surcharge</span>
                                    <span class="font-semibold">+ KES {{ quoteDetails.surcharge | number:'1.2-2' }}</span>
                                </div>
                                <div *ngIf="quoteDetails.discount > 0" class="flex justify-between items-center text-accent-600">
                                    <span>Surcharge</span>
                                    <span class="font-semibold">- KES {{ quoteDetails.discount | number:'1.2-2' }}</span>
                                </div>

                                <div class="border-t border-gray-300 my-2"></div>

                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-secondary">PHCF (0.25%)</span>
                                    <span>KES {{ quoteDetails.phcf | number:'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-secondary">Training Levy (0.2%)</span>
                                    <span>KES {{ quoteDetails.tl | number:'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-secondary">Stamp Duty</span>
                                    <span>KES {{ quoteDetails.sd | number:'1.2-2' }}</span>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="p-4 bg-card dark:bg-gray-900 rounded-xl border-2 border-gray-300 mb-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-secondary">Total Payable</span>
                                    <span class="text-2xl font-bold text-primary-600">KES {{ quoteDetails.netPrem | number:'1.2-2' }}</span>
                                </div>
                            </div>

                            <!-- M-PESA Instructions (After Submission) -->
                            <div *ngIf="applicationSubmitted" class="space-y-4">
                                <div class="p-5 bg-card rounded-xl border-2 border-blue-200 dark:border-blue-900/30">
                                    <div class="flex items-center gap-2 mb-4">
                                        <mat-icon class="text-blue-600">mobile_friendly</mat-icon>
                                        <h4 class="font-bold text-base">M-PESA Payment</h4>
                                    </div>

                                    <div class="space-y-3 mb-4">
                                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900/10 rounded-lg">
                                            <span class="text-sm text-secondary">Paybill</span>
                                            <span class="font-bold text-lg">853338</span>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900/10 rounded-lg">
                                            <span class="text-sm text-secondary">Account</span>
                                            <span class="font-bold text-lg">{{ paymentRefNo }}</span>
                                        </div>
                                    </div>

                                    <mat-form-field appearance="fill" class="w-full">
                                        <mat-label>M-PESA Number</mat-label>
                                        <input
                                            matInput
                                            formControlName="mpesaNumber"
                                            placeholder="07XXXXXXXX"
                                            maxlength="10"
                                            (input)="onMpesaNumberInput($event)">
                                        <mat-icon matPrefix class="text-hint">phone_android</mat-icon>
                                        <mat-hint>Number to receive payment prompt</mat-hint>
                                    </mat-form-field>
                                </div>

                                <button
                                    mat-flat-button
                                    color="accent"
                                    class="w-full text-lg py-6 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all"
                                    [disabled]="isProcessPayment || !paymentForm.get('mpesaNumber')?.value"
                                    (click)="initiatePayment()">
                                    <mat-spinner *ngIf="isProcessPayment" diameter="20" class="mr-2"></mat-spinner>
                                    <mat-icon *ngIf="!isProcessPayment" class="mr-2">send</mat-icon>
                                    {{ isProcessPayment ? 'Processing...' : 'Send Payment Prompt' }}
                                </button>

                                <div class="flex items-center justify-center gap-2 text-xs text-secondary">
                                    <mat-icon class="icon-size-4">info</mat-icon>
                                    <span>Enter your M-PESA PIN when prompted</span>
                                </div>
                            </div>

                            <!-- Submit Button (Before Submission) -->
                            <div *ngIf="!applicationSubmitted">
                                <button
                                    mat-flat-button
                                    color="primary"
                                    class="w-full text-lg py-6 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all"
                                    [disabled]="isSubmitting"
                                    (click)="submitPolicy()">
                                    <mat-spinner *ngIf="isSubmitting" diameter="20" class="mr-2"></mat-spinner>
                                    <mat-icon *ngIf="!isSubmitting" class="mr-2">check_circle</mat-icon>
                                    {{ isSubmitting ? 'Submitting...' : 'Submit Application' }}
                                </button>

                                <div class="mt-3 flex items-center justify-center gap-2 text-xs text-secondary">
                                    <mat-icon class="icon-size-4">info</mat-icon>
                                    <span>Payment available after submission</span>
                                </div>
                            </div>
                            </div>
                        </div>

                    </div>
                    </div>
                    </form>
                </mat-step>

            </mat-horizontal-stepper>
        </div>
    </div>
</div>

